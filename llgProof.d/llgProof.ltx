\documentclass[draft,12pt]{amsart}

\usepackage[final]{listings}
\usepackage{float}
\floatstyle{boxed}
\restylefloat{figure}
\usepackage{arydshln}
\usepackage{multirow}
\usepackage{needspace}

\usepackage{thmtools}

\newcommand{\Pipe}{\charâ€˜\|}
\newcommand{\See}[2]{\emph{see} #1}
\usepackage{amssymb}
\usepackage{wasysym} % Used for \Circle
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{ragged2e}
\usepackage{url}
\usepackage[final]{hyperref}
\usepackage{placeins}
\usepackage{mfirstuc}
\usepackage{ifdraft}
\usepackage[obeyDraft]{todonotes}
\usepackage{datetime2}
\ifdraft{
    \usepackage{draftwatermark}
}{}

% Fix conflict between todonotes and amsart packages
% See http://ctan.math.washington.edu/tex-archive/macros/latex/contrib/todonotes/todonotes.pdf,
% p. 10.
\makeatletter
\providecommand\@dotsep{5}
\def\listtodoname{List of TODOs}
\def\listoftodos{\@starttoc{tdo}\listtodoname}
\makeatother

\makeatletter
\renewcommand{\listofalgorithms}{\@starttoc{loa}{List of algorithms}}
\let\l@algorithm=\l@figure
\makeatother

% Re hbox's, see
% https://tex.stackexchange.com/questions/241343/what-is-the-meaning-of-fussy-sloppy-emergencystretch-tolerance-hbadness
\raggedbottom

% Replaced by todonotes package
% \newcommand{\todo}[1]{\par{\large\bf Todo: #1}\par}

\newcommand{\mymathop}[1]{\mathop{\texttt{#1}}}
\newcommand{\mymathbin}[1]{\mathbin{\texttt{#1}}}

% For a type name, when it occurs in text
\newcommand{\type}[1]{\ensuremath{\texttt{#1}}}

\newcommand{\mult}{\mathbin{\ast}}
\newcommand{\dfn}[1]{{\bf #1}}
\newcommand{\sep}{\,\mid\,}
\newcommand{\mydot}{\raisebox{.05em}{$\,\bullet\,$}}
\newcommand{\cat}{\,.\,}
\newcommand{\size}[1]{\ensuremath{\left | {#1} \right |}}
\newcommand{\Vsize}[1]{\ensuremath{\size{\var{#1}}}}
\newcommand{\bigsize}[1]{\ensuremath{\bigl| {#1} \bigr|}}
\newcommand{\order}[1]{\ensuremath{{\mathcal O}(#1)}\xspace}
\newcommand{\Oc}{\order{1}}
\newcommand{\On}{\order{\var{n}}}
\newcommand{\inference}[2]{\genfrac{}{}{1pt}{}{#1}{#2}}

\newcommand{\lastix}[1]{\ensuremath{\##1}}
\newcommand{\Vlastix}[1]{\ensuremath{\lastix{\V{#1}}}}
\newcommand{\VlastElement}[1]{\Velement{#1}{\Vlastix{#1}}}
\newcommand{\element}[2]{\ensuremath{\mathop{#1}
    \mathopen{}\left[#2\right]\mathclose{}}}
\newcommand{\Velement}[2]{\ensuremath{\mathop{\V{#1}}
    \mathopen{}\left[#2\right]\mathclose{}}}
\newcommand{\VVelement}[2]{\ensuremath{\mathop{\V{#1}}
    \mathopen{}\left[ \V{#2}
    \right]\mathclose{} }}

% \newcommand{\tuple}[1]{\ensuremath{\left\langle #1 \right\rangle}}
\newcommand{\tuple}[1]{\ensuremath{\mathopen{}\left[#1\right]\mathclose{}}}

\newcommand{\mcolon}{\mathrel:}
\newcommand{\mcoloncolon}{\mathrel{\vcenter{\hbox{$::$}}}}

\newcommand{\suchthat}{\mcoloncolon}
\newcommand{\quantify}[3]{% quantifier, binding, predicate
    \ensuremath{\mathrel{#1}#2 \; \suchthat \; #3}%
}

\newcommand{\existUniqQOp}{\mathop{\exists{!}}}
\newcommand{\existUniqQ}[2]{\quantify{\existUniqQOp}{#1}{#2}}
% extra {} in existQOP and univQOp to raise to baseline
\newcommand{\existQOp}{\mathop{\exists{}}}
\newcommand{\existQ}[2]{\quantify{\existQOp}{#1}{#2}}
% extra {} in existQOP and univQOp to raise to baseline
\newcommand{\univQOp}{\mathop{\forall{}\,}}
\newcommand{\univQ}[2]{\quantify{\univQOp}{#1}{#2}}

% I use hyphens in variable names,
% so I need to ensure that subtraction is
% clearly distinguished by the typography
\newcommand{\subtract}{\,-\,}

\newcommand{\var}[1]{\ensuremath{\texttt{#1}}}
\newcommand{\V}[1]{\ensuremath{\texttt{\mbox{#1}}}}

\newcommand{\cfg}{CFG}

\newcommand{\de}{\mathrel{::=}}
\newcommand{\derives}{\Rightarrow}
\newcommand{\destar}
    {\mathrel{\mbox{$\:\stackrel{\!{\ast}}{\Rightarrow\!}\:$}}}
\newcommand{\deplus}
    {\mathrel{\mbox{$\:\stackrel{\!{+}}{\Rightarrow\!}\:$}}}
\newcommand{\derivg}[1]{\mathrel{\mbox{$\:\Rightarrow\:$}}}
\newcommand{\derivrg}[2]{\mathrel{\mbox{$\:\stackrel{\!{#1}}%
        {\Rightarrow\!}\:$}}}

% For the type subscript for powersets
\newcommand{\setOf}[1]{{{#1}^{\mbox{\normalsize $\ast$}}}}

\newcommand{\set}[1]{{\left\lbrace #1 \right\rbrace} }
\newcommand{\bigset}[1]{{\bigl\lbrace #1 \bigr\rbrace} }
\newcommand{\Bigset}[1]{{\Bigl\lbrace #1 \Bigr\rbrace} }

% use internal counter of algorithmicx
\newcommand{\algnested}{ %
  \makeatletter\ALG@nested\makeatother %
}

\newcommand{\algstrut}{\rule{0pt}{.85\baselineskip}}

\newcommand{\myparbox}[2][\algparwidth]{%
  \parbox[t]{#1}{%
  % \linespread{1.15}\selectfont
  \ignorespaces#2\par%
  }%
}

\newcommand{\parcomment}[2]{\hspace{\dimexpr \algorithmicindent * #1}$\triangleright$ #2}

% \newcommand{\rawparcomment}[2][\algparwidth]{%
  % \myparbox[#1]{#2}%
% }
% \newcommand{\parcomment}[2][\algparwidth]{%
  % \myparbox[#1]{$\triangleright$ #2}%
% }
% \newcommand{\parcomment}[1]{\hspace{\dimexpr \algorithmicindent - \labelwidth }$\triangleright$
  % \protect\parbox[t]{\dimexpr \textwidth - (\algorithmicindent - \labelwidth)}{#1}%
% }

% I want to use 'call' outside of pseudocode
\newcommand\call[2]{\textproc{#1}\ifthenelse{\equal{#2}{}}{}{(#2)}}%

\newcommand{\mname}[1]{\mbox{\sf #1}}
% [O]perator [A]pplication
\newcommand{\Oname}[1]{\mname{#1}}
% The \mathopen{} and \mathclose{} eliminate unwanted extra space
\newcommand{\OA}[2]{\ensuremath{%
    \mathop{\Oname{#1}}\mathopen{}\left(#2\right)\mathclose{}%
}}
\newcommand{\VOA}[2]{\OA{#1}{\V{#2}}}
% [F]unction [A]pplication, replaces \myfn
\newcommand{\smallrawfn}[2]{\ensuremath{\mathop{#1}(#2)}}
% The \mathopen{} and \mathclose{} eliminate unwanted extra space
\newcommand{\rawfn}[2]{\ensuremath{\mathop{#1}\mathopen{}\left(#2\right)\mathclose{}}}
\newcommand{\Fname}[1]{\V{#1}}
\newcommand{\FA}[2]{\ensuremath{\rawfn{\mathop{\Fname{#1}}}{#2}}}
\newcommand{\VFA}[2]{\FA{#1}{\V{#2}}}

\newcommand{\cuz}{\ensuremath{\mathrel{\because}}\xspace}
\newcommand{\bcuz}{\linebreak[1]\cuz}

% * Reference meta tags ("classifying prefixes") use in this document:
% * From fancyref:
% Chapter chap:
% Section sec:
% Equation eq:
% Figure fig:
% Table tab:
% Enumeration enum:
% Footnote fn:
%
% * Not in fancyref
% Definition df:
% Epigraph epi:
% Theorem th:
% Lemma lm:
% Remark rm:
% Observation obs:
% Example ex:
% Page page:

% The "page:" metatag is for labels intended as the target of
% page references.

% The auto-placement of qed's fails a lot.
% Semi-manual replacement using \qedhere often fails as well.
% I went with % 100% manual placement,
% which in fact is not any more trouble,
% and which is the only way to guarantee the QED's wind up where I
% want them.

% Try to gather all the stuff to do with theoremoids here
% Start off with theorems, then the other theoremoids,
% mostly alphabetically.

\renewcommand{\qedsymbol}{}
\newcommand{\myqed}{%
  \ifmmode\square
  \else$\square$
  \fi%
}

\newcommand{\colonpageref}[1]{%
 \ifthenelse{\equal{\pageref{#1}}{\thepage}}%
  {}{{:}\pageref*{#1}}%
}

% genref -- generic reference
\newcommand{\genref}[3][]{%
    \ifthenelse{\equal{#1}{}}{}{%
      \ifmmode \text{``#1''}%
      \else``#1'' %
      \fi%
    }%
    (\ensuremath{% To cover both cases, force math mode
        \hyperref[#2]{%
            \textrm{#3}\ref*{#2}\colonpageref{#2}%
        }%
    })%
}

\theoremstyle{definition}

% theoremoids: Th

\newtheorem{theorem}{Theorem}
\newcommand{\Thref}[2][]{%
    \genref[#1]{th:#2}{Th}%
}
% some day delete \longThref
\newcommand{\longThref}[2]{%
  \ifmmode \text{``#1''\Thref{#2}}%
  \else``#1'' \Thref{#2}%
  \fi%
}
% "full" ref -- always includes page
\newcommand{\ThFref}[1]{(\textrm{Th}\ref{#1}:\pageref{#1})}
\newcommand{\thEnd}{\Circle}

% theoremoids: Df

\newtheorem{definition}[theorem]{Definition}
\newcommand{\Dfref}[2][]{%
    \genref[#1]{df:#2}{Df}%
}
\newcommand{\dfEnd}{\Circle}

% theoremoids: Ex

\newtheorem{example}[theorem]{Example}
\newcommand{\Exref}[1]{\genref{ex:#1}{Ex}}
\newcommand{\exEnd}{\Circle}

% theoremoids: Ob

\newtheorem{observation}[theorem]{Observation}
\newcommand{\Obref}[1]{\genref{obs:#1}{Ob}}
\newcommand{\obEnd}{\Circle}

% theoremoids: Rm

\newtheorem{remark}[theorem]{Remark}
\newcommand{\Rmref}[2][]{\genref[#1]{rm:#2}{Rm}}
\newcommand{\rmEnd}{\Circle}

% local theoremoids: Lm

\newtheorem{lemma}[theorem]{Lemma}
\newcommand{\Lmref}[2][]{\genref[#1]{lm:#2}{Lm}}
% some day delete \longLmref
\newcommand{\longLmref}[2]{%
  \ifmmode \text{``#1''\Lmref{#2}}%
  \else``#1'' \Lmref{#2}%
  \fi%
}
\newcommand{\lmEnd}{\thEnd}

\newcommand{\naturals}{\ensuremath{\mathbb{N}}\xspace}
\newcommand{\countables}{\ensuremath{\mathbb{CNT}}\xspace}
\newcommand{\integers}{\ensuremath{\mathbb{Z}}\xspace}

\hyphenation{oper-and oper-ands}
\hyphenation{look-ahead}
\hyphenation{memo-ization}

% I like to silence underfull hbox messages.
% This is syntactic sugar for doing that.
\newenvironment{MYsloppy}[1][3em]{\par\tolerance9999 \emergencystretch#1\relax}{\par}
% This form allows the resetting of hbadness, which may be necessary to
% shut up an "underfull" warning.
\newenvironment{MYsloppyB}[2]{\par\tolerance9999 \emergencystretch#1 \hbadness#2\relax}{\par}
% This form is for a trick:  Tolerances are evaluated line by line, so a tolerance
% less than 9999 may produce a better looking paragraph and reduce the "badness".
\newenvironment{MYsloppyC}[3]{\par\tolerance#3 \emergencystretch#1 \hbadness#2\relax}{\par}

\title
  [llguidance proof]
  {Completeness proof for llguidance Earley variant}

\author{Jeffrey Kegler}
\ifdraft{
    % legacy draftwatermark options -- update?
    \SetWatermarkLightness{0}
    \SetWatermarkText{DRAFT \DTMnow{} DRAFT}
    \SetWatermarkAngle{0}
    \SetWatermarkScale{.4}
    % \SetWatermarkHorCenter{1.5in}
    \SetWatermarkVerCenter{.5in}
}{}
\ifdraft{ \thanks{DRAFT as of \DTMnow} }{}
\date{\DTMnow.}

\newcommand{\llguidance}{{\tt llguidance}\xspace}
\newcommand{\llE}{{\llguidance Earley}\xspace}
\newcommand{\pref}[1]{\ref{#1} on page~\pageref{#1}\xspace}

\begin{document}

\maketitle
\tableofcontents

\section{About this document}
\label{sec:about-me}

This document contains a proof of completeness for the variant of
Earley's algorithm in \llguidance.
It assumes some familiarity with the code in
\llguidance\cite{llguidance},
and with the traditional proof of correctness
for Earley's algorithm.\footnote{%
    As found, for example,
    in~\cite[pp. 323-325]{AH1972v1}.
    }

\section{Conventions}
\begin{itemize}
\item ``Iff'' (or ``iff'') abbreviates
    ``if and only if''.
\item Ranges are inclusive start,
    exclusive end, so that, for example,
        \begin{gather*}
            \element{(\texttt{"abcd"})}{0,2} = \texttt{"ab"} \text{, and} \\
            \element{(\texttt{"abcd"})}{2,3} = \texttt{"c"}.
        \end{gather*}
\end{itemize}

\section{Definitions}

\begin{definition}[The input \V{w}]
        In  this paper, \V{w} is a string of symbols.
        The ``symbols'' are, for our purposes, an unordered
        set of opaque objects.
        We call the string \V{w}, the \textbf{input}.
        \dfEnd
\end{definition}

\begin{definition}[The grammar \V{g}]
\label{df:g}
We will consider the proper grammar
\[
        \V{g} = \tuple{\V{N},\V{T},\V{P},\V{S}},
\]
where \V{N} (the non-terminals)
and \V{T} (the terminals) are disjoint sets of symbols.
$\V{S} \in \V{N}$ is
the start symbol.
\V{P} is the set of rules, or productions.
The rules are of the form
$\V{A} \de \V{rhs}$,
where $\V{A} \in \V{N}$
and
$\V{rhs} \in (\V{N}\cup\V{T})^\ast$.

We will write an Earley item as
\[
        \tuple{\V{A} \de \alpha \mydot \beta, \V{origin}, \V{current}}
\]
where $\alpha$ and $\beta$ are sentential forms,
\[
        \alpha \in (\V{N} \cup \V{T}^\ast) \land \beta \in (\V{N} \cup \V{T})^\ast,
\]
and $\V{A} \de \alpha \cat \beta$ is a rule in the grammar \V{g},
\[
        (\V{A} \de \alpha \cat \beta) \in \V{P}.
\]
A large raised dot ($\mydot$) indicates the dot location in the rule.
\V{origin} is the origin location of the item in the input, and
\V{current} is the location of the dot in the input,
or dot location.

When we say that \V{g} is proper we mean that it has
no unreachable symbols, no unproductive symbol,
and no cycles. \dfEnd
\end{definition}

\begin{definition}[Predot symbol]
In an Earley item
\[
        \tuple{\V{A} \de \alpha \mydot \beta, \V{origin}, \V{current}},
\]
we call the last symbol in $\alpha$, \element{\alpha}{\lastix{\alpha}},
the predot symbol.
When $\size{\alpha} = 0$, there is no predot symbol. \dfEnd
\end{definition}

\begin{definition}[Types of Earley items]
We say that an Earley item is predicted, or a \textbf{prediction}
if it has no predot symbol.
We say that an Earley item is \textbf{confirmed}, or a confirmation,
if it is not a prediction.
We say that an Earley item is \textbf{scanned}, or a \textbf{scansion},
if its predot symbol is a terminal,
                 $\element{\alpha}{\lastix{\alpha}} \in \V{T}$.
We say that an Earley item is reduced, or a \textbf{reduction},
if its predot symbol is a non-terminal,
$\element{\alpha}{\lastix{\alpha}} \in \V{N}$.
We say that an Earley item is a \textbf{nullable reduction}
if it is a reduction whose predot symbol is nullable.
We say that an Earley item is a \textbf{non-nullable reduction}
if it is a reduction whose predot symbol is non-nullable. \dfEnd
\end{definition}

\begin{definition}[Derivation set instances]
\label{df:di}
A \textbf{derivation set instance} (DI)
is of the form
\[
        \FA{DI}{\V{predot},\V{postdot},\V{A},\V{origin},\V{current}}
\]
and is defined as
\begin{equation}
        \label{eq:def-DI-1}
        \begin{gathered}
        \V{predot} \in (\V{N} \cup \V{T})^\ast \land \V{postdot} \in (\V{N} \cup \V{T})^\ast \\
                \land \; (\V{A} \de \V{predot} \cat \V{postdot}) \in \V{P}
        \end{gathered}
\end{equation}
\todo{Explicate this equation in text?}
and
\begin{equation}
        \label{eq:def-DI-2}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdot} \neq \epsilon ) \\
                \implies \;
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                \destar \Velement{w}{0,\V{origin}} \cat \V{predot} \mydot \V{postdot} \cat \V{unseen2} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdot} \cat \V{unseen2}
                \end{gathered} \right)
                }
        \end{gathered}
\end{equation}
\dfEnd
\end{definition}

\todo{Explicate this equation in text?}
In \Dfref{di},
$\V{origin} < \V{current} \lor \size{\V{postdot}} \neq \epsilon$
indicates that we do not create zero length completed Earley items.
Note our use of the raised dot ($\mydot$)
in DI's is not formally part of the derivation in which
it occurs,
but is used as a reading aid,
for convenience in locating the dot position.

\begin{definition}[Fundamental invariant]
The fundamental invariant\footnote{
        This fundamental invariant is similar to the traditional
        one, as found in~\cite[Slide 12/39]{Kallmeyer2018}
        and~\cite[Theorem 4.9, p. 323]{AH1972v1}
}
for the \llguidance
Earley parser is
\begin{gather}
        \label{eq:invariant-eim}
        \tuple{\V{A} \de \V{predotA} \mydot \V{postdotA}, \V{origin}, \V{current}}
                \text{ in \V{Rows}} \\
        \label{eq:invariant-di}
                \equiv \; \FA{DI}{\V{predotA},\V{postdotA},\V{A},\V{origin},\V{current}}.
\end{gather}

The DI \eqref{eq:invariant-di} is said to
        \textbf{correspond} to the Earley item
\eqref{eq:invariant-eim}
\dfEnd
\end{definition}

\begin{definition}[DI concepts and Earley items]
        An Earley item concept applied to a DI
        is true iff the concept is true of the
        corresponding Earley item of the DI.
        For example, an Earley item is a reduction
        iff its corresponding DI is a reduction.
        \dfEnd
\end{definition}

\begin{definition}[Tangible reduction DI]
        \label{df:rt}
        A \textbf{tangible reduction}
        is a reduction DI whose predot symbol derives,
        in every derivation,
        at least one terminal.
\end{definition}

\begin{definition}[Intangible reduction DI]
        A \textbf{intangible reduction},
        or \textbf{nulling reduction},
        is a reduction DI which is not a tangible
        reduction DI.
        \dfEnd
\end{definition}

\begin{definition}[Tangible reduction inflows]
\label{df:tangible-inflows}
        Suppose, without loss of generality, that
\begin{equation}
        \V{down} = \FA{DI}{\V{antepredotA}\cat\V{B},\V{postdotA},\V{A},\V{origin},\V{current}} \\
\end{equation}
is a tangible reduction DI
        where
\begin{gather*}
        \V{B} \de \V{rhs} \in \V{P}
        \land \; \V{B} \deplus \Velement{w}{\V{originB},\V{current}}.
\end{gather*}
Then we say that
\begin{itemize}
\item a DI of the form
\[
        \V{tributary} = \FA{DI}{\V{rhs},\epsilon,\V{B},\V{originB},\V{current}}
\]
        is a \textbf{tributary} of
        \V{down};
\item
a DI of the form
\begin{equation*}
        \V{mainstem} =
        \FA{DI}{
        \begin{gathered}
        \; \V{antepredotA}, \; \V{B}\cat\V{postdotA}, \; \\
                \V{A},\; \V{origin},\; \V{originB}
        \end{gathered}
}
\end{equation*}
        is a \textbf{mainstem} of
        \V{down}:
\item
        \V{down} is the \textbf{downstream channel}
        (or simply \textbf{downstream})
        of \V{tributary}; and
\item
        \V{down} is the \textbf{downstream channel}
        (or simply \textbf{downstream})
        of \V{mainstem}.
        \dfEnd
\end{itemize}
\end{definition}

\begin{definition}[Intangible reduction inflows]
\label{df:intangible-inflows}
        \todo{Clean this up}
        Suppose, without loss of generality, that
\begin{equation}
        \V{down} = \FA{DI}{\V{antepredotA}\cat\V{B},\V{postdotA},\V{A},\V{origin},\V{current}} \\
\end{equation}
is an intangible reduction DI.
Then we say that
\begin{itemize}
\item
a DI of the form
\begin{equation*}
        \V{mainstem} =
        \FA{DI}{
        \begin{gathered}
        \; \V{antepredotA}, \; \V{B}\cat\V{postdotA}, \; \\
                \V{A},\; \V{origin},\; \V{current}
        \end{gathered}
}
\end{equation*}
        is a \textbf{mainstem} of
        \V{down}:
\item
        \V{down} is the \textbf{downstream channel}
        (or simply \textbf{downstream})
        of \V{mainstem}.
        \dfEnd
\end{itemize}
\end{definition}

We will divide the confirmed DIs at each current location
into \textbf{generations}.
Scanned DIs are in generation 0.
If \V{diAfter} is in generation \V{z} and
\[ \V{diBefore} \derives \V{diAfter} \]
is a step instance,
then
\V{diBefore} is in generation $\V{z}+1$.

\section{Inflow lemmas}

\begin{lemma}[Reduction tributary]
        \label{lm:rt}
        Every tangible reduction DI
        (Definition~\ref{df:rt} on page~\pageref{df:rt})
        has a tributary
        (Definition~\ref{df:tangible-inflows} on page~\pageref{df:tangible-inflows})
        .  \lmEnd
\end{lemma}

\begin{proof}
        We assumed for the lemma that we have a tangible reduction DI.
        Without loss of generality, let this be
\begin{equation}
        \label{eq:df-rt-di}
        \V{down} = \FA{DI}{\V{antepredotA}\cat\V{B},\V{postdotA},\V{A},\V{origin},\V{current}}, \\
\end{equation}
        \todo{Make sure predot symbol is defined}
where
\begin{gather}
        \label{eq:rt-di-pr-10}
\V{antepredotA} \in(\V{N}\cup\V{T})^\ast, \\
        \label{eq:rt-di-pr-12}
\text{The predot symbol instance derives $\Velement{w}{\V{originB},\V{current}}$, and} \\
        \label{eq:rt-di-pr-16}
\V{originB} < \V{current}.
\end{gather}

        We can expand the DI \V{down} in \ref{eq:df-rt-di} to
\begin{gather}
        \V{antepredotA}\cat\V{B} \in (\V{N} \cup \V{T})^\ast \\
        \land \; \V{postdotA} \in (\V{N} \cup \V{T})^\ast \\
        \label{eq:rt-di-pr-22}
        \land \; (\V{A} \de \V{antepredotA} \cat \V{B} \cat \V{postdotA}) \in \V{P} \text{, and} \\
        \label{eq:rt-di-pr-24}
        \left( \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdot} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}
                \end{gathered} \right)
                }
        \end{gathered} \right)
\end{gather}

Interpolating
\eqref{eq:rt-di-pr-12} into
\eqref{eq:rt-di-pr-24},
we get to
\begin{gather}
        \label{eq:rt-di-pr-44}
        \left( \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdot} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \begin{gathered}
                                \deplus \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2}
                        \end{gathered} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}
                \end{gathered} \right)
                }
        \end{gathered} \right)
\end{gather}
We note that one of the derivation steps is
        \eqref{eq:rt-di-pr-44},
        \[
                \begin{gathered}
         \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2},
                \end{gathered}
\]
so that $\V{origin} \le \V{originB}$
and since from \eqref{eq:rt-di-pr-16} we know
$\V{originB} < \V{current}$
we have $\V{origin} \le \V{originB} < \V{current}$ or
\begin{equation}
\label{eq:rt-di-pr-46}
    \V{origin} < \V{current}.
\end{equation}
Using \eqref{eq:rt-di-pr-46},
        we may simplify
\eqref{eq:rt-di-pr-44}
to
\begin{equation}
        \label{eq:rt-di-pr-64}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \begin{gathered}
                        \deplus \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2}
                        \end{gathered} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}

In \eqref{eq:df-rt-di}, we assumed for the theorem that
the DI \V{down} is a tangible reduction,
so that
\begin{equation}
        \label{eq:rt-di-pr-66}
        \V{B} \in \V{N}
\end{equation}
and, for some $\V{rhs} \in (\V{N}\cup\V{T})^\ast$,
\begin{equation}
        \label{eq:rt-di-pr-67}
        \V{B} \de \V{rhs} \in \V{P}.
\end{equation}

Interpolating
\eqref{eq:rt-di-pr-67} into
\eqref{eq:rt-di-pr-64},
we get to
\begin{equation}
        \label{eq:rt-di-pr-68}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \derives \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat \V{rhs} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \begin{gathered}
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2}
                        \end{gathered} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}

From \eqref{eq:rt-di-pr-68}, we note
\begin{equation}
         \label{eq:rt-di-pr-70}
        \begin{gathered}
                        \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \\
                        \destar \Velement{w}{0,\V{current}}.
        \end{gathered}
\end{equation}
so that
\begin{equation}
         \label{eq:rt-di-pr-72}
        \V{antepredotA} \derives \Velement{w}{\V{origin},\V{originB}}.
\end{equation}
Interpolating \eqref{eq:rt-di-pr-72} into \eqref{eq:rt-di-pr-68},
we have
\begin{equation}
        \label{eq:rt-di-pr-76}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \derives \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}}
                                \cat \V{rhs} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \begin{gathered}
                        \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}}
                                \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2}
                        \end{gathered} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}
From \eqref{eq:rt-di-pr-76},
by merging \Velement{w}{0,\V{origin}} with \Velement{w}{\V{origin},\V{originB}},
and by eliminating steps unneeded for what follows, we arrive at
\begin{equation}
        \label{eq:rt-di-pr-80}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{originB}} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \derives \Velement{w}{0,\V{originB}} \cat \V{rhs} \mydot \V{postdotA} \cat \V{unseen2} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}
We next
eliminate all references to the non-terminal \V{A},
and to the rule with \V{A} on its LHS \eqref{eq:rt-di-pr-22}.
As part of this, we switch the existential variable to \V{unseen},
where
\[
\V{unseen} = \V{postdotA} \cat \V{unseen2}.
\]
This lets us state
\begin{equation}
        \label{eq:rt-di-pr-84}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{originB}} \cat \V{B} \cat \V{unseen} \\
                        \derives \Velement{w}{0,\V{originB}} \cat \V{rhs} \mydot \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{unseen}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}
We want to make \eqref{eq:rt-di-pr-84} take the proper form for a DI,
so we add an antecedent inside the existential:
\begin{equation}
\label{eq:rt-di-pr-88}
        \begin{gathered}
        \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
        ( \V{originB} < \V{current} \lor \epsilon \neq \epsilon ) \implies \\
                \left( \begin{gathered}
        \V{S} \destar \Velement{w}{0,\V{originB}} \cat \V{B} \cat \V{unseen} \\
                \derives \Velement{w}{0,\V{originB}} \cat \V{rhs} \mydot \V{unseen} \\
        \destar \Velement{w}{0,\V{current}} \mydot \V{unseen}
                \end{gathered}  \right).
        }
        \end{gathered}
\end{equation}
From the rule for B \eqref{eq:rt-di-pr-12},
we know that
\begin{equation}
\label{eq:rt-di-pr-90}
\V{rhs} \in (\V{N}\cup\V{T})^\ast.
\end{equation}
Together,
\eqref{eq:rt-di-pr-12},
\eqref{eq:rt-di-pr-88} and
\eqref{eq:rt-di-pr-90} are equivalent to the DI
\begin{equation}
\label{eq:rt-di-pr-94}
\FA{DI}{\V{rhs},\epsilon,\V{B},\V{originB},\V{current}}.
\end{equation}
From \Dfref{tangible-inflows}, we see that
\eqref{eq:rt-di-pr-94} is the tributary of \eqref{eq:df-rt-di}.
Therefore, with
\eqref{eq:rt-di-pr-94}, we have what we needed to show for the lemma.
        \myqed
\end{proof}

\begin{lemma}[Tangible reduction mainstem]
        \label{lm:rt-main}
        Every tangible reduction DI \Dfref{rt}
        has a mainstem \Dfref{tangible-inflows}.
        \lmEnd
\end{lemma}

\begin{proof}
        We assumed for the lemma that we have a tangible reduction DI.
        Without loss of generality, let this be
\begin{equation}
        \label{eq:pr-rm-di}
        \V{down} = \FA{DI}{\V{antepredotA}\cat\V{B},\V{postdotA},\V{A},\V{origin},\V{current}}, \\
\end{equation}
where
\begin{gather}
        \label{eq:pr-rt-main-10}
\V{antepredotA} \in(\V{N}\cup\V{T})^\ast, \\
        \label{eq:pr-rt-main-14}
\text{The predot symbol instance derives $\Velement{w}{\V{originB},\V{current}}$ and} \\
        \label{eq:pr-rt-main-16}
\V{originB} < \V{current}.
\end{gather}
        \todo{Define predot symbol instance}

        We can expand the DI \V{down} in \ref{eq:pr-rm-di} to
\begin{gather}
        \label{eq:pr-rt-main-20}
        \V{antepredotA}\cat\V{B} \in (\V{N} \cup \V{T})^\ast \\
        \land \; \V{postdotA} \in (\V{N} \cup \V{T})^\ast \\
        \label{eq:pr-rt-main-22}
        \land \; (\V{A} \de \V{antepredotA} \cat \V{B} \cat \V{postdotA}) \in \V{P} \text{, and} \\
        \label{eq:pr-rt-main-24}
        \left( \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdotA} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen}
                \end{gathered} \right)
                }
        \end{gathered} \right).
\end{gather}

If we incorporate \eqref{eq:pr-rt-main-14}
into \eqref{eq:pr-rt-main-24}, we have
\begin{equation}
        \label{eq:pr-rt-main-28}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdotA} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                            \qquad \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                        \V{postdotA} \cat \V{unseen}
                \end{gathered} \right).
                }
        \end{gathered}
\end{equation}

From within \eqref{eq:pr-rt-main-28}, we can isolate
\begin{equation}
\label{eq:pr-rt-main-30}
\Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \cat \Velement{w}{\V{originB},\V{current}}.
\end{equation}
\begin{gather}
\label{eq:pr-rt-main-32}
        \V{origin} \le \V{originB} \cuz \eqref{eq:pr-rt-main-30}. \\
\label{eq:pr-rt-main-34}
        \V{origin} < \V{current} \cuz \eqref{eq:pr-rt-main-32}, \eqref{eq:pr-rt-main-16}.
\end{gather}

We can now use \eqref{eq:pr-rt-main-34} to simplify \eqref{eq:pr-rt-main-24}:
\begin{equation}
        \label{eq:pr-rt-main-38}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen}.
                }
        \end{gathered}
\end{equation}

From \eqref{eq:pr-rt-main-14}
and \eqref{eq:pr-rt-main-38}
we see that
\begin{equation}
        \label{eq:pr-rt-main-40}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \cat \Velement{w}{\V{originB},\V{current}}
                                \mydot \V{postdotA} \cat \V{unseen}.
                }
        \end{gathered}
\end{equation}


The dot location is not part of the derviations,
and may be moved earlier on the RHS without
changing the set of derivations in the DI of \eqref{eq:pr-rt-main-38}.
We now move the dot from after the predot symbol instance,
to before it.
\begin{equation}
        \label{eq:pr-rt-main-42}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \mydot \Velement{w}{\V{originB},\V{current}}
                                \cat \V{postdotA} \cat \V{unseen}.
                }
        \end{gathered}
\end{equation}

To begin to put \eqref{eq:pr-rt-main-42} into the form of a DI expansion,
we first pull back the frontier,
so that \V{B} is in the last step of the derivation schema
\todo{define derivation schema}
instead of \Velement{w}{\V{originB},\V{current}}.
\begin{equation}
        \label{eq:pr-rt-main-44}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{originB}} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen}.
                }
        \end{gathered}
\end{equation}

In moving from \eqref{eq:pr-rt-main-42} to
\eqref{eq:pr-rt-main-44} we become indifferent to the terminals which V{B} produces
in \eqref{eq:pr-rt-main-44}.
As a result, the derivation set \eqref{eq:pr-rt-main-44} is a superset
of the derivation set \eqref{eq:pr-rt-main-42}.
Our chain of deductions remains valid, because it remains the case
that the DI expansion that we are about to deduce is implied by all the
derivations in the derivation set \eqref{eq:pr-rt-main-42}.

We now proceed to shape \eqref{eq:pr-rt-main-44}
back into the form of a DI expansion.
We first add an antecedant:
\begin{equation}
        \label{eq:pr-rt-main-48}
        \begin{gathered}
                ( \V{originB} < \V{current} \lor (\V{B} \cat \V{postdotA} \neq \epsilon) ) \implies \\
                \left( \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{originB}} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen}
                \end{gathered} \right).
                }
        \end{gathered}
\end{equation}
In addition to \eqref{eq:pr-rt-main-48}, the DI expansion requires some
preliminary assumptions.
To obtain these, we note
\begin{gather}
        \label{eq:pr-rt-main-50}
        \V{antepredotA} \in (\V{N} \cup \V{T})^\ast \cuz \eqref{eq:pr-rt-main-20}. \\
        \label{eq:pr-rt-main-52}
        \V{B} \cat \V{postdotA} \in (\V{N} \cup \V{T})^\ast \cuz \eqref{eq:pr-rt-main-20}.
\end{gather}
Equations \eqref{eq:pr-rt-main-22}, \eqref{eq:pr-rt-main-48}, \eqref{eq:pr-rt-main-50} and
\eqref{eq:pr-rt-main-52} are the expansion of the DI
\begin{equation}
\label{eq:pr-rt-main-54}
        \V{main} = \FA{DI}{\V{antepredotA}, \V{B}\cat\V{postdotA},\V{A},\V{origin},\V{originB}}. \\
\end{equation}
From \Dfref{tangible-inflows}, we see that
\eqref{eq:pr-rt-main-54} is the tributary of \eqref{eq:df-rt-di}.
Therefore, with
\eqref{eq:pr-rt-main-54}, we have what we needed to show for the lemma.
\todo{Recheck proof of reduction DI mainstem lemma}
\myqed
\end{proof}

\section{Confirmation lemmas}

\begin{lemma}
        Let \V{diRed} be a reductive DI in generation $\V{g}+1$ of row \V{current}.
        If rows 0 through $\V{current} \subtract 1$ are complete,
        and generations
        0 through \V{g} in row \V{current} are complete,
        then \llguidance adds the Earley item corresponding to
        \V{diRed} to its Earley table.
        \todo{Reduction DI lemma here}
        \lmEnd
\end{lemma}

\begin{proof}
        \todo{Proof of reduction DI lemma here}
        \myqed
\end{proof}

\FloatBarrier

{
\clearpage

% Ragged right, do not hyphenate.
\RaggedRight
\hyphenpenalty=10000
\exhyphenpenalty=10000

% Silence current hbox warnings, but allow them if
% badness increases further
\hbadness=2000

\begin{thebibliography}{10}

\bibitem{AH1972v1}
\newblock{Aho, Alfred V., and Jeffrey D. Ullman.}
\newblock{\em The theory of parsing, translation, and compiling. Vol. 1.}
\newblock{Prentice-Hall, 1972.}

\bibitem{Kallmeyer2018}
\newblock{Laura Kallmeyer.}
\newblock{``Parsing: Earley parsing''.}
\newblock{Winter 2017/2018, Heinrich Heine Universitaet, Dusseldorf.}
\newblock{\url{https://user.phil-fak.uni-duesseldorf.de/~kallmeyer/Parsing/earley.pdf}.
        Retrieved 18 Sep 2024.}

\bibitem{Kegler2023}
\newblock{Jeffrey Kegler.}
\newblock{``Marpa, A practical general parser: the recognizer''.}
\newblock{\url{https://arxiv.org/abs/1910.08129}.
   Retrieved 2 December, 2024.}

\bibitem{llguidance}
\newblock{llguidance team.}
\newblock{"Low-level guidance parser".}
\newblock{
  \url{https://github.com/microsoft/llguidance}.
  Retrieved 2 December, 2024.}

\end{thebibliography}

} % RaggedRight

% \clearpage
% \phantomsection
% \listofalgorithms

\clearpage
\phantomsection
\renewcommand{\listtheoremname}{Formal apparatus}

\clearpage
\phantomsection
\pdfbookmark[0]{\listtheoremname}{listoflemmas}
% swapnumber would be cool, but is not in the thmtools in
% the latest Raspbian
\listoftheorems[ignoreall,onlynamed=observation,
    show={lemma,ldef,theorem,example,remark,definition}]

\ifdraft{
    \clearpage
    \phantomsection
    \listoftodos
}{}

\end{document}
