\documentclass[draft,12pt]{amsart}
\usepackage{float}
\usepackage{algorithm}
\usepackage{algpseudocode}

\usepackage[final]{listings}
\usepackage{float}
\floatstyle{boxed}
\restylefloat{figure}
\usepackage{arydshln}
\usepackage{multirow}
\usepackage{needspace}

\usepackage{thmtools}

\newcommand{\Pipe}{\charâ€˜\|}
\newcommand{\See}[2]{\emph{see} #1}
\usepackage{amssymb}
\usepackage{wasysym} % Used for \Circle
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{ragged2e}
\usepackage{url}
\usepackage[final]{hyperref}
\usepackage{placeins}
\usepackage{mfirstuc}
\usepackage{ifdraft}
\usepackage[obeyDraft]{todonotes}
\usepackage{datetime2}
\ifdraft{
        \usepackage[
    colorspec=0,
    text=DRAFT\ \DTMnow{}\ DRAFT,
    angle=0,
    scale=1.5,
    fontsize=12pt,
    vpos=.5in
        ]{draftwatermark}
}{}

% Fix conflict between todonotes and amsart packages
% See http://ctan.math.washington.edu/tex-archive/macros/latex/contrib/todonotes/todonotes.pdf,
% p. 10.
\makeatletter
\providecommand\@dotsep{5}
\def\listtodoname{List of TODOs}
\def\listoftodos{\@starttoc{tdo}\listtodoname}
\makeatother

\makeatletter
\renewcommand{\listofalgorithms}{\@starttoc{loa}{List of algorithms}}
\let\l@algorithm=\l@figure
\makeatother

% Re hbox's, see
% https://tex.stackexchange.com/questions/241343/what-is-the-meaning-of-fussy-sloppy-emergencystretch-tolerance-hbadness
\raggedbottom

% Replaced by todonotes package
% \newcommand{\todo}[1]{\par{\large\bf Todo: #1}\par}

\newcommand{\mymathop}[1]{\mathop{\texttt{#1}}}
\newcommand{\mymathbin}[1]{\mathbin{\texttt{#1}}}

% For a type name, when it occurs in text
\newcommand{\type}[1]{\ensuremath{\texttt{#1}}}

\newcommand{\True}{\mbox{\sf T}\xspace}
\newcommand{\False}{\mbox{\sf F}\xspace}
\newcommand{\Trueword}{\sf true}
\newcommand{\Falseword}{\sf false}
\newcommand{\Neg}{\neg}
\newcommand{\Implies}{\supset}
\newcommand{\ImpliesAlt}{\Rightarrow}
\newcommand{\NEquiv}{\not\equiv}
\newcommand{\NEquivRel}{\mathrel{\not\equiv}}

\newcommand{\qeq}{\simeq}
\newcommand{\nqeq}{\not\simeq}
\newcommand{\unicorn}{\ensuremath{\bot}\xspace}
\newcommand{\TRUE}{\ensuremath{\mathbb T}\xspace}
\newcommand{\FALSE}{\ensuremath{\mathbb F}\xspace}

\newcommand{\mult}{\mathbin{\ast}}
\newcommand{\dfn}[1]{{\bf #1}}
\newcommand{\sep}{\,\mid\,}
\newcommand{\mydot}{\raisebox{.05em}{$\,\bullet\,$}}
\newcommand{\cat}{\,.\,}
\newcommand{\size}[1]{\ensuremath{\left | {#1} \right |}}
\newcommand{\Vsize}[1]{\ensuremath{\size{\var{#1}}}}
\newcommand{\bigsize}[1]{\ensuremath{\bigl| {#1} \bigr|}}
\newcommand{\order}[1]{\ensuremath{{\mathcal O}(#1)}\xspace}
\newcommand{\Oc}{\order{1}}
\newcommand{\On}{\order{\var{n}}}
\newcommand{\inference}[2]{\genfrac{}{}{1pt}{}{#1}{#2}}

\newcommand{\lastix}[1]{\ensuremath{\##1}}
\newcommand{\Vlastix}[1]{\ensuremath{\lastix{\V{#1}}}}
\newcommand{\VlastElement}[1]{\Velement{#1}{\Vlastix{#1}}}
\newcommand{\element}[2]{\ensuremath{\mathop{#1}
    \mathopen{}\left[#2\right]\mathclose{}}}
\newcommand{\Velement}[2]{\ensuremath{\mathop{\V{#1}}
    \mathopen{}\left[#2\right]\mathclose{}}}
\newcommand{\VVelement}[2]{\ensuremath{\mathop{\V{#1}}
    \mathopen{}\left[ \V{#2}
    \right]\mathclose{} }}

% \newcommand{\tuple}[1]{\ensuremath{\left\langle #1 \right\rangle}}
\newcommand{\tuple}[1]{\ensuremath{\mathopen{}\left[#1\right]\mathclose{}}}

\newcommand{\mcolon}{\mathrel:}
\newcommand{\mcoloncolon}{\mathrel{\vcenter{\hbox{$::$}}}}

% \newcommand{\suchthat}{\mcoloncolon}
% In this paper, use \mid
\newcommand{\suchthat}{\mid}
\newcommand{\quantify}[3]{% quantifier, binding, predicate
    \ensuremath{\mathrel{#1}#2 \; \suchthat \; #3}%
}

\newcommand{\existUniqQOp}{\mathop{\exists{!}}}
\newcommand{\existUniqQ}[2]{\quantify{\existUniqQOp}{#1}{#2}}
% extra {} in existQOP and univQOp to raise to baseline
\newcommand{\existQOp}{\mathop{\exists{}}}
\newcommand{\existQ}[2]{\quantify{\existQOp}{#1}{#2}}
% extra {} in existQOP and univQOp to raise to baseline
\newcommand{\univQOp}{\mathop{\forall{}\,}}
\newcommand{\univQ}[2]{\quantify{\univQOp}{#1}{#2}}

% I use hyphens in variable names,
% so I need to ensure that subtraction is
% clearly distinguished by the typography
\newcommand{\subtract}{\,-\,}

\newcommand{\var}[1]{\ensuremath{\texttt{#1}}}
\newcommand{\V}[1]{\ensuremath{\texttt{\mbox{#1}}}}

\newcommand{\cfg}{CFG}

\newcommand{\de}{\mathrel{::=}}
\newcommand{\derives}{\Rightarrow}
\newcommand{\destar}
    {\mathrel{\mbox{$\:\stackrel{\!{\ast}}{\Rightarrow\!}\:$}}}
\newcommand{\destarW}[1]
    {\mathrel{\mbox{$\:\underset{#1}{\overset{\ast\:}{\Rightarrow}}$}}}
\newcommand{\destarV}[1]{\destarW{\V{#1}}}
\newcommand{\deplus}
    {\mathrel{\mbox{$\:\stackrel{\!{+}}{\Rightarrow\!}\:$}}}
\newcommand{\deplusW}[1]
    {\mathrel{\mbox{$\:\underset{#1}{\overset{{+}\:}{\Rightarrow}}$}}}
\newcommand{\deplusV}[1]{\deplusW{\V{#1}}}
\newcommand{\derivg}[1]{\mathrel{\mbox{$\:\Rightarrow\:$}}}
\newcommand{\derivrg}[2]{\mathrel{\mbox{$\:\stackrel{\!{#1}}%
        {\Rightarrow\!}\:$}}}

% For the type subscript for powersets
\newcommand{\setOf}[1]{{{#1}^{\mbox{\normalsize $\ast$}}}}

\newcommand{\set}[1]{{\left\lbrace #1 \right\rbrace} }
\newcommand{\bigset}[1]{{\bigl\lbrace #1 \bigr\rbrace} }
\newcommand{\Bigset}[1]{{\Bigl\lbrace #1 \Bigr\rbrace} }

\DeclareMathOperator{\wrt}{wrt}

% use internal counter of algorithmicx
\newcommand{\algnested}{ %
  \makeatletter\ALG@nested\makeatother %
}

\newcommand{\algstrut}{\rule{0pt}{.85\baselineskip}}



% I use parboxes in equations.  This sets a useful width for them.
\newlength{\mathparwidth}
\newlength{\longtagwidth}
\settowidth{\longtagwidth}{(99999)\quad}
\setlength{\mathparwidth}{\dimexpr\textwidth-\longtagwidth}
\newcommand{\myparbox}[2][\mathparwidth]{%
  \parbox[t]{#1}{%
  % \linespread{1.15}\selectfont
  \ignorespaces#2\par%
  }%
}

\newcommand{\parcomment}[2]{\hspace{\dimexpr \algorithmicindent * #1}$\triangleright$ #2}

% \newcommand{\rawparcomment}[2][\algparwidth]{%
  % \myparbox[#1]{#2}%
% }
% \newcommand{\parcomment}[2][\algparwidth]{%
  % \myparbox[#1]{$\triangleright$ #2}%
% }
% \newcommand{\parcomment}[1]{\hspace{\dimexpr \algorithmicindent - \labelwidth }$\triangleright$
  % \protect\parbox[t]{\dimexpr \textwidth - (\algorithmicindent - \labelwidth)}{#1}%
% }

% I want to use 'call' outside of pseudocode
\newcommand\call[2]{\textproc{#1}\ifthenelse{\equal{#2}{}}{}{(#2)}}%

\newcommand{\mname}[1]{\mbox{\sf #1}}
% [O]perator [A]pplication
\newcommand{\Oname}[1]{\mname{#1}}
% The \mathopen{} and \mathclose{} eliminate unwanted extra space
\newcommand{\OA}[2]{\ensuremath{%
    \mathop{\Oname{#1}}\mathopen{}\left(#2\right)\mathclose{}%
}}
\newcommand{\VOA}[2]{\OA{#1}{\V{#2}}}
% [F]unction [A]pplication, replaces \myfn
\newcommand{\smallrawfn}[2]{\ensuremath{\mathop{#1}(#2)}}
% The \mathopen{} and \mathclose{} eliminate unwanted extra space
\newcommand{\rawfn}[2]{\ensuremath{\mathop{#1}\mathopen{}\left(#2\right)\mathclose{}}}
\newcommand{\Fname}[1]{\V{#1}}
\newcommand{\FA}[2]{\ensuremath{\rawfn{\mathop{\Fname{#1}}}{#2}}}
\newcommand{\VFA}[2]{\FA{#1}{\V{#2}}}

\newcommand{\cuz}{\ensuremath{\mathrel{\because}}\xspace}
\newcommand{\bcuz}{\linebreak[1]\cuz}

% * Reference meta tags ("classifying prefixes") use in this document:
% * From fancyref:
% Chapter chap:
% Section sec:
% Equation eq:
% Figure fig:
% Table tab:
% Enumeration enum:
% Footnote fn:
%
% * Not in fancyref
% Definition df:
% Epigraph epi:
% Theorem th:
% Lemma lm:
% Remark rm:
% Observation obs:
% Example ex:
% Page page:

% The "page:" metatag is for labels intended as the target of
% page references.

% The auto-placement of qed's fails a lot.
% Semi-manual replacement using \qedhere often fails as well.
% I went with % 100% manual placement,
% which in fact is not any more trouble,
% and which is the only way to guarantee the QED's wind up where I
% want them.

% Try to gather all the stuff to do with theoremoids here
% Start off with theorems, then the other theoremoids,
% mostly alphabetically.

\renewcommand{\qedsymbol}{}
\newcommand{\myqed}{%
  \ifmmode\square
  \else$\square$
  \fi%
}

\newcommand{\colonpageref}[1]{%
 \ifthenelse{\equal{\pageref{#1}}{\thepage}}%
  {}{{:}\pageref*{#1}}%
}

% genref -- generic reference
\newcommand{\genref}[3][]{%
    \ifthenelse{\equal{#1}{}}{}{%
      \ifmmode \text{``#1''}%
      \else``#1'' %
      \fi%
    }%
    (\ensuremath{% To cover both cases, force math mode
        \hyperref[#2]{%
            \textrm{#3}\ref*{#2}\colonpageref{#2}%
        }%
    })%
}

\theoremstyle{definition}

% theoremoids: Th

\newtheorem{theorem}{Theorem}
\newcommand{\Thref}[2][]{%
    \genref[#1]{th:#2}{Th}%
}
% some day delete \longThref
\newcommand{\longThref}[2]{%
  \ifmmode \text{``#1''\Thref{#2}}%
  \else``#1'' \Thref{#2}%
  \fi%
}
% "full" ref -- always includes page
\newcommand{\ThFref}[1]{(\textrm{Th}\ref{#1}:\pageref{#1})}
\newcommand{\thEnd}{\Circle}

% theoremoids: Df

\newtheorem{definition}[theorem]{Definition}
\newcommand{\Dfref}[2][]{%
    \genref[#1]{df:#2}{Df}%
}
\newcommand{\dfEnd}{\Circle}

% theoremoids: Eq

\newcommand{\Algref}[1]{\genref{alg:#1}{Alg}}
\newcommand{\Eqref}[1]{\genref{eq:#1}{Eq}}

% theoremoids: Ex

\newtheorem{example}[theorem]{Example}
\newcommand{\Exref}[1]{\genref{ex:#1}{Ex}}
\newcommand{\exEnd}{\Circle}

% theoremoids: Ob

\newtheorem{observation}[theorem]{Observation}
\newcommand{\Obref}[1]{\genref{obs:#1}{Ob}}
\newcommand{\obEnd}{\Circle}

% theoremoids: Rm

\newtheorem{remark}[theorem]{Remark}
\newcommand{\Rmref}[2][]{\genref[#1]{rm:#2}{Rm}}
\newcommand{\rmEnd}{\Circle}

% local theoremoids: Lm

\newtheorem{lemma}[theorem]{Lemma}
\newcommand{\Lmref}[2][]{\genref[#1]{lm:#2}{Lm}}
% some day delete \longLmref
\newcommand{\longLmref}[2]{%
  \ifmmode \text{``#1''\Lmref{#2}}%
  \else``#1'' \Lmref{#2}%
  \fi%
}
\newcommand{\lmEnd}{\thEnd}

\newcommand{\naturals}{\ensuremath{\mathbb{N}}\xspace}
\newcommand{\countables}{\ensuremath{\mathbb{CNT}}\xspace}
\newcommand{\integers}{\ensuremath{\mathbb{Z}}\xspace}

\hyphenation{oper-and oper-ands}
\hyphenation{look-ahead}
\hyphenation{memo-ization}

% I like to silence underfull hbox messages.
% This is syntactic sugar for doing that.
\newenvironment{MYsloppy}[1][3em]{\par\tolerance9999 \emergencystretch#1\relax}{\par}
% This form allows the resetting of hbadness, which may be necessary to
% shut up an "underfull" warning.
\newenvironment{MYsloppyB}[2]{\par\tolerance9999 \emergencystretch#1 \hbadness#2\relax}{\par}
% This form is for a trick:  Tolerances are evaluated line by line, so a tolerance
% less than 9999 may produce a better looking paragraph and reduce the "badness".
\newenvironment{MYsloppyC}[3]{\par\tolerance#3 \emergencystretch#1 \hbadness#2\relax}{\par}

\title
  [llguidance proof]
  {Completeness proof for llguidance Earley variant}

\author{Jeffrey Kegler}
\ifdraft{ \thanks{DRAFT as of \DTMnow} }{}
\date{\DTMnow.}

\newcommand{\llguidance}{{\tt llguidance}\xspace}
\newcommand{\llE}{{\llguidance Earley}\xspace}
\newcommand{\pref}[1]{\ref{#1} on page~\pageref{#1}\xspace}

\begin{document}

\maketitle
\tableofcontents

\section{About this document}
\label{sec:about-me}

This document contains a proof of completeness for the variant of
Earley's algorithm in \llguidance.
It assumes some familiarity with the code in
\llguidance\cite{llguidance},
and with the traditional proof of correctness
for Earley's algorithm.\footnote{%
    As found, for example,
    in~\cite[pp. 323-325]{AH1972v1}.
    }

\section{Conventions}
\noindent $\bullet$
``Iff'' (or ``iff'') abbreviates
    ``if and only if''.
\noindent $\bullet$
``Wrt'' (or ``wrt'') abbreviates
    ``with respect to''.
\noindent $\bullet$
Ranges are inclusive start,
    exclusive end, so that, for example,
        \begin{gather*}
            \element{(\texttt{"abcd"})}{0,2} = \texttt{"ab"} \text{, and} \\
            \element{(\texttt{"abcd"})}{2,3} = \texttt{"c"}.
        \end{gather*}
\noindent $\bullet$ \TRUE is a boolean (or optional boolean) true; and
        \FALSE is a boolean (or optional boolean) false.

\section{Definitions}

\begin{definition}[The input \V{w}]
        In  this paper, \V{w} is a string of symbols.
        The ``symbols'' are, for our purposes, an unordered
        set of opaque objects.
        We call the string \V{w}, the \textbf{input}.
        \dfEnd
\end{definition}

\begin{definition}[The grammar]
\label{df:grammar}
A grammar is a 4-tuple
\[
        \tuple{\V{N},\V{T},\V{P},\V{S}},
\]
where \V{N} (the non-terminals)
and \V{T} (the terminals) are disjoint sets of symbols.
$\V{S} \in \V{N}$ is
the start symbol.
\V{P} is the set of rules, or productions.
The rules are of the form
$\V{A} \de \V{rhs}$,
where $\V{A} \in \V{N}$
and
$\V{rhs} \in (\V{N}\cup\V{T})^\ast$.
\dfEnd
\end{definition}

\begin{definition}[The grammar \V{g}]
\label{df:g}
When we say that \V{g} is \textbf{proper} we mean that it has
no unreachable symbols, no unproductive symbol,
and no cycles.
Every grammar in this document is the proper grammar
\[
        \V{g} = \tuple{\V{N},\V{T},\V{P},\V{S}}. \qquad \dfEnd
\]
\end{definition}

\begin{definition}[Earley item]
We will write an Earley item as
\[
        \tuple{\V{A} \de \alpha \mydot \beta, \V{origin}, \V{current}}
\]
where $\alpha$ and $\beta$ are sentential forms,
\[
        \alpha \in (\V{N} \cup \V{T}^\ast) \land \beta \in (\V{N} \cup \V{T})^\ast,
\]
and $\V{A} \de \alpha \cat \beta$ is a rule in the grammar \V{g},
\[
        (\V{A} \de \alpha \cat \beta) \in \V{P}.
\]
A large raised dot ($\mydot$) indicates the dot location in the rule.
\V{origin} is the origin location of the item in the input, and
\V{current} is the location of the dot in the input,
or dot location.
\dfEnd
\end{definition}

\begin{definition}[Predot symbol]
In an Earley item
\[
        \tuple{\V{A} \de \alpha \mydot \beta, \V{origin}, \V{current}},
\]
we call the last symbol in $\alpha$, \element{\alpha}{\lastix{\alpha}},
the predot symbol.
When $\size{\alpha} = 0$, there is no predot symbol. \dfEnd
\end{definition}

\begin{definition}[Types of Earley items]
We say that
\begin{itemize}
\item an Earley item is a \textbf{start item}
        if its LHS is the start symbol and
        it has no predot symbol;
\item an Earley item is \textbf{predicted}, or a \textbf{prediction}
        if its LHS is not the start symbol and
        it has no predot symbol;
\item an Earley item is \textbf{confirmed}, or a \textbf{confirmation},
        if it has a predot symbol;
\item an Earley item is \textbf{scanned}, or a \textbf{scansion},
        if its predot symbol is a terminal,
         $\element{\alpha}{\lastix{\alpha}} \in \V{T}$;
\item an Earley item is \textbf{reduced}, or a \textbf{reduction},
        if its predot symbol is a non-terminal;
        $\element{\alpha}{\lastix{\alpha}} \in \V{N}$; \qquad \dfEnd
\end{itemize}
\end{definition}

\begin{definition}[Strings]
\label{df:string}
        A \textbf{string} is a sequence whose members are
        elements of the set $(\V{N}\cup\V{T})$.
        In this document, we will use the symbol \V{STR} for set of finite
        strings,
        and $\V{STR}^+$ for set of non-empty finite strings:
        \[ \V{STR}^+ = \V{STR} \subtract \epsilon. \]
        A \textbf{terminal string} is a sequence whose members are
        elements of the set \V{T}.
        In this document, we will use the symbol \V{TSTR} for set of finite
        terminal strings,
        and $\V{TSTR}^+$ for set of non-empty finite terminal strings:
        \[ \V{TSTR}^+ = \V{TSTR} \subtract \epsilon.  \dfEnd \]
\end{definition}

\begin{definition}[String transition]
        \label{df:transition}
        An \textbf{string transition}
        is a duple of two sentential forms,
        such that a non-terminal member in the first element of the pair
        is expanded, according to a rule of \V{g}, in the second element of the pair.
        More precisely, let $\V{tr} = (\V{Lstr}, \V{Rstr})$ be an SF transition.
        Then, without loss of generality,
        \begin{equation}
                \V{Lstr} = \alpha \cat \V{A} \cat \beta \\
                \land \; \V{Rstr} = \alpha \cat \V{rhsA} \cat \beta \\
                \land \; \V{A} \de \V{rhsA} \in \V{P}
        \end{equation}
        where $\alpha$ and $\beta$ are strings.
        Overloading terminology a bit,
        \V{Lstr} is called the \textbf{LHS} string of \V{tr},
        and \V{Rstr} is called the \textbf{RHS} string of \V{tr}.
        \dfEnd
\end{definition}

\begin{definition}[Trivial derivation]
        In \Dfref{transition} the symbols in
        $\alpha$ and $\beta$ are simply copied --- they can
        be said to be derived from themselves.
        We say that the
        $\alpha$ and $\beta$ in \V{Rstr}
        are \textbf{trivially derived} from
        $\alpha$ and $\beta$ in \V{Lstr}.
        We also that that
        the substrings of $\alpha$ and $\beta$ in \V{Lstr}
        are \textbf{trivially derived} from
        the corresponding substrings of $\alpha$ and $\beta$ in \V{Lstr};
        and that
        the symbol instances of $\alpha$ and $\beta$ in \V{Lstr}
        are \textbf{trivially derived} from
        the corresponding symbol instances in $\alpha$ and $\beta$ in \V{Lstr};
\dfEnd
\end{definition}

\begin{definition}[Derivation]
        A derivation, call it \V{drv}, is a sequence of strings
        such that every consecutive pair of the sequence is a string transition.
        The individual members of a derivation are strings,
        and in the context of the derivation are called \V{steps}.
        \dfEnd
\end{definition}

\begin{definition}[Symbol instance]
        A symbol may occur many times in a derivation.
        Each occurrence can be identified by the index of the step (\V{stepIX}),
        within the derivation (\V{drv}),
        and the index (\V{pos}) of the symbol occurrence within the string,
        so that the triple $(\V{stepIX}, \V{pos}, \V{drv})$ represents
        a symbol instance.
        More practically, we will tag symbols with an instance identifier,
        separated from the symbol name by a colon, so that \V{A:f} represents
        the instance of symbol \V{A} with the tag ''\texttt{f}''.
        For convenience in reading derivations,
        trivial derivatives of a symbol instance often carry the same tag
        as their LHS instance.
        \dfEnd
\end{definition}

\begin{definition}[Sentences and Sentential forms]
        If the first step of a derivation is $\V{S}$,
        the string consisting only of the start symbol,
every step in the derivation is a \textbf{sentential form}.
If a sentential form consists entirely of terminals,
it is a \textbf{sentence}.
\dfEnd
\end{definition}

\begin{definition}[Focused derivation]
\label{df:di}
A \textbf{focused derivation} (FD)
is a derivation with a matching focus.
We can write the focus of a focused derivation as a 5-tuple.
For example, the focus of \eqref{eq:def-DI-010}-\eqref{eq:def-DI-040}
can be written as
\[
        \FA{FOCUS}{\V{predot},\V{postdot},\V{A:f},\V{origin},\V{current}}.
\]
The LHS symbol of the focus is identified with the instance tag ``\texttt{f}''.
The LHS symbol instance is tagged because
otherwise a focus can appear at multiple points
in a derivation.

A focused derivation can be written in ``expanded'' form as
\begin{gather}
        \label{eq:def-DI-010}
        \V{predot} \in \V{STR} \\
        \label{eq:def-DI-020}
        \land \; \V{postdot} \in \V{STR} \\
        \label{eq:def-DI-030}
        \land \; (\V{A} \de \V{predot} \cat \V{postdot}) \in \V{P}
\end{gather}
and
\begin{equation}
        \label{eq:def-DI-040}
        \begin{gathered}
                \existQ{ \V{unseen} \in \V{STR} }{ \\
                ( \V{origin} < \V{current} \lor \V{postdot} \neq \epsilon ) \\
                \implies \;
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A:f} \cat \V{unseen} \\
                \derives \Velement{w}{0,\V{origin}} \cat \V{predot} \mydot \V{postdot} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdot} \cat \V{unseen}
                \end{gathered} \right)
                }
        \end{gathered}
\end{equation}

We note that the focus, by dividing the RHS of the transition into two pieces,
also distinguishes a ``dot position'' in the RHS step.
In the expanded form of a focused derivation,
the dot position could be found by the diligent reader,
but for convenience it is shown with a raised dot,
and that raised dot is usually carried through into the later
derivation steps in the expanded form.
Similarly, the
the trivial derivatives of a tagged symbol is often shown with the
same tag as their LHS symbol.
\dfEnd
\end{definition}

\begin{definition}[Focus to derivation match]
        A derivation which is consistent with the expanded form of
        a focus, as in \Dfref{fd}, is said to \textbf{match} the focus,
        and vice versa.
        We note that more than one derivation may match a focus.
        We also note that, when instance tags are not used,
        more than one focus may match a derivation.
\dfEnd
\end{definition}

\begin{definition}[Earley item to focus correspondence]
The Earley item 
\[
        \tuple{\V{A} \de \V{predotA} \mydot \V{postdotA}, \V{origin}, \V{current}}
\]
\textbf{corresponds} to the focus
\[
        \FA{FOCUS}{\V{predotA},\V{postdotA},\V{A},\V{origin},\V{current}}
\]
and vice versa.  \dfEnd
\end{definition}

\begin{definition}[Soundness]
A set of Earley items is \textbf{sound} for an input \V{w} iff
the corresponding focus of every Earley item
matches a derivation with input \V{w}.
\dfEnd
\end{definition}

\begin{definition}[Completeness]
A set of Earley items is \textbf{complete} for an input \V{w} with
respect to a set of focuses iff
for every focus in that set,
either that focus is a nulling completion,
or its Earley item is in \V{Rows}.  \dfEnd
\end{definition}

We note carefully that \Dfref{completeness} differs from
the usual definition of completeness in Earley parsing,
in excepting nulling completions from the definition.

\begin{definition}[Fundamental invariant]
The \textbf{fundamental invariant}\footnote{
This fundamental invariant is similar to the traditional
one, as found in~\cite[Theorem 4.9, p. 323]{AH1972v1}
}
requires the set of Earley items in a Earley stack
to be both sound and complete.

The focus \eqref{eq:invariant-di} is said to
\textbf{correspond} to the Earley item, and vice versa.
\dfEnd
\end{definition}

\begin{definition}[DI concepts and Earley items]
        An Earley item concept applied to a DI
        is true iff the concept is true of the
        corresponding Earley item of the DI.
        For example, an Earley item is a reduction
        iff its corresponding DI is a reduction.
        \dfEnd
\end{definition}

\begin{definition}[Tangible symbol]
        In the context of a derivation,
        a \textbf{tangible} symbol instance is one that produces
        at least one terminal,
        and an \textbf{intangible} symbol instance in one that is
        not tangible.
        \dfEnd
\end{definition}

\begin{definition}[Tangible reduction FD]
        \label{df:rt}
        A \textbf{tangible reduction}
        is a focused derivation,
        where the focus is a reduction,
        and the predot symbol instance in the derivation
        is tangible.
        A \textbf{intangible reduction}
        is a focused derivation,
        where the focus is a reduction,
        and the predot symbol instance in the derivation
        is intangible.
        \dfEnd
\end{definition}

\begin{definition}[Tangible reduction inflows]
\label{df:tangible-inflows}
        \todo{Rewrite this}|
        Suppose, without loss of generality, that
\begin{equation}
        \V{down} = \FA{DI}{\V{antepredotA}\cat\V{B},\V{postdotA},\V{A},\V{origin},\V{current}} \\
\end{equation}
is a tangible reduction FD
        where
\begin{gather*}
        \V{B} \de \V{rhs} \in \V{P}
        \land \; \V{B} \deplus \Velement{w}{\V{originB},\V{current}}.
\end{gather*}
Then we say that
\begin{itemize}
\item a DI of the form
\[
        \V{tributary} = \FA{DI}{\V{rhs},\epsilon,\V{B},\V{originB},\V{current}}
\]
        is a \textbf{tributary} of
        \V{down};
\item
a DI of the form
\begin{equation*}
        \V{mainstem} =
        \FA{DI}{
        \begin{gathered}
        \; \V{antepredotA}, \; \V{B}\cat\V{postdotA}, \; \\
                \V{A},\; \V{origin},\; \V{originB}
        \end{gathered}
}
\end{equation*}
        is a \textbf{mainstem} of
        \V{down}:
\item
        \V{down} is the \textbf{downstream channel}
        (or simply \textbf{downstream})
        of \V{tributary}; and
\item
        \V{down} is the \textbf{downstream channel}
        (or simply \textbf{downstream})
        of \V{mainstem}.
        \dfEnd
\end{itemize}
\end{definition}

\begin{definition}[Intangible reduction inflows]
\label{df:intangible-inflows}
        \todo{Rewrite this}
        Suppose, without loss of generality, that
\begin{equation}
        \V{down} = \FA{DI}{\V{antepredotA}\cat\V{B},\V{postdotA},\V{A},\V{origin},\V{current}} \\
\end{equation}
is an intangible reduction DI.
Then we say that
a DI of the form
\begin{equation*}
        \V{mainstem} =
        \FA{DI}{
        \begin{gathered}
        \; \V{antepredotA}, \; \V{B}\cat\V{postdotA}, \; \\
                \V{A},\; \V{origin},\; \V{current}
        \end{gathered}
}
\end{equation*}
        is a \textbf{mainstem} of
        \V{down}.
We also say that \V{down} is the \textbf{downstream channel}
(or simply \textbf{downstream})
of \V{mainstem}.
\dfEnd
\end{definition}

\begin{definition}[Prediction inflows]
\label{df:prediction-inflows}
        Suppose, without loss of generality, that
\begin{equation}
        \V{down} = \FA{DI}{\epsilon,\V{rhsA},\V{A},\V{current},\V{current}} \\
\end{equation}
is an prediction DI.
Then we say that
any DI of the form
\begin{equation*}
        \V{mainstem} =
        \FA{DI}{
        \begin{gathered}
        \; \V{predotB}, \; \V{A} \cat\V{afterPostdotB}, \; \\
                \V{B},\; \V{originB},\; \V{current}
        \end{gathered}
}
\end{equation*}
        is a \textbf{mainstem} of
        \V{down}.
We also say that \V{down} is the \textbf{downstream channel}
(or simply \textbf{downstream})
of \V{mainstem}.
\dfEnd
\end{definition}

\begin{definition}[Generations]
        \label{df:generation}
        Scansions and start Earley items belong to generation 0.
        The generation of all other Earley items is that of their
        first generation candidate.

        If an Earley item \V{down} has a \textbf{generation inflow} whose generation is \V{i},
        $\V{i}+1$ is a \textbf{generation candidate} of \V{down}.
        The generation inflow of predictions is its mainstem.
        The generation inflow of an intangible reduction is its mainstem.
        The generation inflow of an tangible reduction is its tributary.
        \dfEnd
\end{definition}

Note that \Dfref{generation} implies that every generation inflow
has the same current location as its downstream.

\todo{Prove that every confirmed Earley item belongs to a generation
        within its row -- this will require soundness}

\needspace{3in}
\section{Algorithm}
\label{sec:algorithm}
\FloatBarrier

\begin{algorithm}[ht]
\caption{Do Earley Parse}
\label{alg:earley}
\begin{algorithmic}[1]
        \Procedure{DoEarleyParse}{}
        \State \Call {AddRow0}{}
        \For{$\V{i} \gets 1, \Vsize{\V{w}}$}
                \State \Call {AddRow}{\V{i}}
        \EndFor
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[ht]
\caption{Add Row 0}
\label{alg:add-row-0}
\begin{algorithmic}[1]
        \Procedure{AddRow0}{}
        \State \Call {AddStartStates}{}
        \State \Call {FinishRow}{0}
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[ht]
        \caption{Add Row \V{n}}
\label{alg:add-row-n}
\begin{algorithmic}[1]
        \Procedure{AddRow}{\V{n}}
        \State \Call {AddScansions}{\V{n}}
        \State \Call {FinishRow}{\V{n}}
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[ht]
        \caption{Finish Row \V{n}}
\label{alg:finish-row}
\begin{algorithmic}[1]
        \Procedure{FinishRow}{\V{n}}
        \State $\V{i} \gets 0$ \Comment {Initialize \V{i}}
        \While {$\V{i} < \Vsize{row}$} \Comment {This loop adds items at the end of \V{row},
            so that \Vsize{row} will increase in the course of running this loop}
        \State $\V{current} \gets \Velement{row}{\V{i}}$
                \Comment {\VVelement{row}{i} is \V{i}'th Earley item in row}
        \If {\V{current} is complete}
             \State $\V{origin} \gets$ origin of \V{current}
             \If {$\V{origin} < \V{n}$}
                  \State \Call{AddTangibleReductions}{\V{current}}
             \EndIf
        \Else \Comment {... else if \V{current} is an incompletion}
             \State $\V{postdot} \gets$ postdot symbol of \V{current}
             \If {\V{postdot} is nullable}
                  \State \Call{AddIntangibleReduction}{\V{current}}
             \EndIf
             \State \Call{AddPredictions}{\V{postdot},\V{n}}
        \EndIf
        \State $\V{i} \gets \V{i} + 1$
        \EndWhile
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[ht]
        \caption{Add Tangible Reductions}
\label{alg:tangible-reductions}
\begin{algorithmic}[1]
        \Procedure{AddTangibleReductions}{\V{tributary}}
        \State $\V{tribOrigin} \gets \text{origin of \V{tributary}}$
        \State $\V{tribCurrent} \gets \text{current location of \V{tributary}}$
        \State $\V{tribLHS} \gets \text{LHS of \V{tributary}`s rule}$
        \State $\V{originRow} \gets \VVelement{rows}{tribOrigin}$
        \Statex\Comment Find the row where \V{tributary} starts
        \State $\V{mainstems} \gets$
        \Statex $\qquad \qquad \lbrace \V{item} \in \V{originRow} \mid \VFA{Postdot}{item} =  \V{tribLHS} \rbrace$
        \Statex \Comment {Set \V{mainstems} to the set of Earley items in \V{originRow} whose postdot
                item is \V{tribLHS}.}
     \For {$\V{mainstem} \in \V{mainstems}$}
          \State $\V{dotted} \gets \text{dotted rule of \V{mainstem}}$
          \State $\V{newDotted} \gets \Call{AdvanceDot}{\V{dotted}}$
          \State $\V{newOrigin} \gets \text{origin of \V{mainstem}}$
          \State $\V{reduction} \gets ( \V{newDotted}, \V{newOrigin}, \V{tribCurrent} )$
          \Statex \Comment Create a new Earley item
          \State If \V{reduction} is new, add it to \V{rows}, at the end
     \EndFor
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[ht]
        \caption{Advance Dot}
\label{alg:advance-dot}
\begin{algorithmic}[1]
        \Function{AdvanceDot}{\V{dottedRule}}
        \State \textbf{let} \V{dottedRule} \text{be} $(\V{A} \de \alpha \mydot \V{B} \cat \beta)$
        \State $\qquad \qquad \textbf{where } \alpha, \beta \in (\V{N}\cup\V{T})^\ast \text{ and }  \V{B} \in (\V{N}\cup\V{T})$
        \State \textbf{return} $(\V{A} \de \alpha \cat \V{B} \mydot \beta)$
\EndFunction
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[ht]
        \caption{Add Intangible Reduction}
\label{alg:intangible-reductions}
\begin{algorithmic}[1]
        \Procedure{AddIntangibleReduction}{\V{mainstem}}
        \State $\V{currLoc} \gets \text{current location of \V{mainstem}}$
        \State $\V{dotted} \gets \text{dotted rule of \V{mainstem}}$
        \State $\V{newDotted} \gets \Call{AdvanceDot}{\V{dotted}}$
        \State $\V{newOrigin} \gets  \text{origin of \V{mainstem}}$
        \State $\V{reduction} \gets ( \V{newDotted}, \V{newOrigin}, \V{currLoc} )$
        \Statex \Comment Create a new Earley item
        \State If \V{reduction} is new, add it to \V{rows}, at the end
\EndProcedure
\end{algorithmic}
\end{algorithm}

\begin{algorithm}[ht]
        \caption{Add Predictions}
\label{alg:predictions}
\begin{algorithmic}[1]
        \Procedure{AddPredictions}{\V{sym},\V{currLoc}}
        \For {every \V{rule} such that $\V{sym} \de \alpha$ and $\alpha \in (\V{N}\cup\V{T})^\ast$}
        \Statex \Comment for every \V{rule} in grammar with LHS equal to \V{sym}
                \State $\V{prediction} \gets ( (\V{sym} \de \mydot \alpha), \V{currLoc}, \V{currLoc} )$
                \Statex \Comment Create a new Earley item
                \State If \V{prediction} is new, add it to \V{rows}, at the end
        \EndFor
\EndProcedure
\end{algorithmic}
\end{algorithm}

\FloatBarrier

\section{Inflow lemmas}

\begin{lemma}[DI antecedant helper]
\label{lm:di-ante-help}
        Unless a DI is a nulling completion,
        either its origin is properly before the current location,
        or it is a completion.
        That is, let
        \begin{equation}
                \label{eq:di-ante-help-010}
                \V{di} = \FA{DI}{\V{predotA},\V{postdotA},\V{A},\V{origin},\V{current}}.
        \end{equation}
        If
        \begin{equation}
                \label{eq:di-ante-help-020}
                \neg ( \V{A} \destarW{\V{di}} \epsilon \land \V{postdotA} = \epsilon)
        \end{equation}
        then
        \begin{equation}
                \label{eq:di-ante-help-030}
                \V{origin} < \V{current} \lor \V{postdotA} \neq \epsilon.
        \end{equation}
\end{lemma}

\begin{proof}
        We are assuming \eqref{eq:di-ante-help-020} for the theorem.
        Let us assume for a deduction that \V{di} is a completion,
        \begin{equation}
                \label{eq:di-ante-help-050}
                \V{postdotA} = \epsilon
                \text{ \cuz assumed for a deduction.}
        \end{equation}
        \begin{equation}
                \label{eq:di-ante-help-060}
                \neg ( \V{A} \destarW{\V{di}} \epsilon )
                \,\cuz\, \eqref{eq:di-ante-help-020}, \eqref{eq:di-ante-help-050}.
        \end{equation}
        \begin{equation}
                \label{eq:di-ante-help-070}
                \begin{gathered}
                \neg
                \left( \begin{gathered}
                        \V{A} \destarW{\V{di}} \V{predotA} \cat \V{postdotA} \\
                        \destarW{\V{di}} \Velement{w}{\V{origin},\V{current}} \cat \V{postdotA} \\
                        \destarW{\V{di}} \epsilon. \\
                \end{gathered} \right) \\
                \cuz \eqref{eq:di-ante-help-010}, \Dfref{di}.
                \end{gathered}
        \end{equation}
        \begin{equation}
                \label{eq:di-ante-help-080}
                \begin{gathered}
                \neg ( \Velement{w}{\V{origin},\V{current}} \destarW{\V{di}} \epsilon ) \\
                \cuz \eqref{eq:di-ante-help-050}, \eqref{eq:di-ante-help-070}.
                \end{gathered}
        \end{equation}
        We have been careful in our notation in this proof to include the
        context DS of our derivations because this proof uses negation
        of derivation sets, whose consequences can be non-obvious \Obref{derivation-set-negation}.
        \begin{equation}
                \label{eq:di-ante-help-090}
                \begin{gathered}
                        \exists \; \alpha, \beta \in (\V{N} \cup \V{T})^\ast, \V{term} \in \V{T} \mid \\
                        \Velement{w}{\V{origin},\V{current}} \destarW{\V{di}} \alpha \cat \V{t} \cat \beta \\
                \cuz \Obref{derivation-set-negation}, \eqref{eq:di-ante-help-080}.
                \end{gathered}
        \end{equation}
        \begin{equation}
                \label{eq:di-ante-help-100}
                \begin{gathered}
                        \V{origin} < \V{current} \,\cuz\, \eqref{eq:di-ante-help-090}.
                \end{gathered}
        \end{equation}
        \begin{equation}
                \label{eq:di-ante-help-110}
                \begin{gathered}
                        \V{postdotA} = \epsilon \implies \V{origin} < \V{current} \\
                        \text{ \cuz deduction of \eqref{eq:di-ante-help-100} from \eqref{eq:di-ante-help-010}.}
                \end{gathered}
        \end{equation}
        \begin{equation}
                \label{eq:di-ante-help-120}
                \V{origin} < \V{current} \lor \V{postdotA} \neq \epsilon \,\cuz\, \eqref{eq:di-ante-help-110}.
        \end{equation}
        Equation \eqref{eq:di-ante-help-120} is equivalent to \Eqref{di-ante-help-030}, which
        is what we needed to show for the lemma.
        \myqed
\end{proof}

\begin{lemma}[Reduction tributary]
        \label{lm:rt}
        Every tangible reduction DI
        (Definition~\ref{df:rt} on page~\pageref{df:rt})
        has a tributary
        (Definition~\ref{df:tangible-inflows} on page~\pageref{df:tangible-inflows}).
        \lmEnd
\end{lemma}

\begin{proof}
        We assumed for the lemma that we have a tangible reduction DI.
        Without loss of generality, let this be
\begin{equation}
        \label{eq:df-rt-di}
        \V{down} = \FA{DI}{\V{antepredotA}\cat\V{B},\V{postdotA},\V{A},\V{origin},\V{current}}, \\
\end{equation}
        \todo{Make sure predot symbol is defined}
where
\begin{gather}
        \label{eq:rt-di-pr-10}
\V{antepredotA} \in(\V{N}\cup\V{T})^\ast, \\
        \label{eq:rt-di-pr-12}
\text{The predot symbol instance derives $\Velement{w}{\V{originB},\V{current}}$, and} \\
        \label{eq:rt-di-pr-16}
\V{originB} < \V{current}.
\end{gather}

        We can expand the DI \V{down} in \ref{eq:df-rt-di} to
\begin{gather}
        \V{antepredotA}\cat\V{B} \in (\V{N} \cup \V{T})^\ast \\
        \land \; \V{postdotA} \in (\V{N} \cup \V{T})^\ast \\
        \label{eq:rt-di-pr-22}
        \land \; (\V{A} \de \V{antepredotA} \cat \V{B} \cat \V{postdotA}) \in \V{P} \text{, and} \\
        \label{eq:rt-di-pr-24}
        \left( \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdot} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}
                \end{gathered} \right)
                }
        \end{gathered} \right)
\end{gather}

Interpolating
\eqref{eq:rt-di-pr-12} into
\eqref{eq:rt-di-pr-24},
we get to
\begin{gather}
        \label{eq:rt-di-pr-44}
        \left( \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdot} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \begin{gathered}
                                \deplus \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2}
                        \end{gathered} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}
                \end{gathered} \right)
                }
        \end{gathered} \right)
\end{gather}
We note that one of the derivation steps is
        \eqref{eq:rt-di-pr-44},
        \[
                \begin{gathered}
         \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2},
                \end{gathered}
\]
so that $\V{origin} \le \V{originB}$
and since from \eqref{eq:rt-di-pr-16} we know
$\V{originB} < \V{current}$
we have $\V{origin} \le \V{originB} < \V{current}$ or
\begin{equation}
\label{eq:rt-di-pr-46}
    \V{origin} < \V{current}.
\end{equation}
Using \eqref{eq:rt-di-pr-46},
        we may simplify
\eqref{eq:rt-di-pr-44}
to
\begin{equation}
        \label{eq:rt-di-pr-64}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \begin{gathered}
                        \deplus \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2}
                        \end{gathered} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}

In \eqref{eq:df-rt-di}, we assumed for the theorem that
the DI \V{down} is a tangible reduction,
so that
\begin{equation}
        \label{eq:rt-di-pr-66}
        \V{B} \in \V{N}
\end{equation}
and, for some $\V{rhs} \in (\V{N}\cup\V{T})^\ast$,
\begin{equation}
        \label{eq:rt-di-pr-67}
        \V{B} \de \V{rhs} \in \V{P}.
\end{equation}

Interpolating
\eqref{eq:rt-di-pr-67} into
\eqref{eq:rt-di-pr-64},
we get to
\begin{equation}
        \label{eq:rt-di-pr-68}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \derives \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat \V{rhs} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \begin{gathered}
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2}
                        \end{gathered} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}

From \eqref{eq:rt-di-pr-68}, we note
\begin{equation}
         \label{eq:rt-di-pr-70}
        \begin{gathered}
                        \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \\
                        \destar \Velement{w}{0,\V{current}}.
        \end{gathered}
\end{equation}
so that
\begin{equation}
         \label{eq:rt-di-pr-72}
        \V{antepredotA} \derives \Velement{w}{\V{origin},\V{originB}}.
\end{equation}
Interpolating \eqref{eq:rt-di-pr-72} into \eqref{eq:rt-di-pr-68},
we have
\begin{equation}
        \label{eq:rt-di-pr-76}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \cat\V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \derives \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}}
                                \cat \V{rhs} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \begin{gathered}
                        \destar \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}}
                                \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                                \V{postdotA} \cat \V{unseen2}
                        \end{gathered} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}
From \eqref{eq:rt-di-pr-76},
by merging \Velement{w}{0,\V{origin}} with \Velement{w}{\V{origin},\V{originB}},
and by eliminating steps unneeded for what follows, we arrive at
\begin{equation}
        \label{eq:rt-di-pr-80}
        \begin{gathered}
                \existQ{ \V{unseen2} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen2} \\
                        \destar \Velement{w}{0,\V{originB}} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen2} \\
                        \derives \Velement{w}{0,\V{originB}} \cat \V{rhs} \mydot \V{postdotA} \cat \V{unseen2} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen2}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}
We next
eliminate all references to the non-terminal \V{A},
and to the rule with \V{A} on its LHS \eqref{eq:rt-di-pr-22}.
As part of this, we switch the existential variable to \V{unseen},
where
\[
\V{unseen} = \V{postdotA} \cat \V{unseen2}.
\]
This lets us state
\begin{equation}
        \label{eq:rt-di-pr-84}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{originB}} \cat \V{B} \cat \V{unseen} \\
                        \derives \Velement{w}{0,\V{originB}} \cat \V{rhs} \mydot \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{unseen}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}
We want to make \eqref{eq:rt-di-pr-84} take the proper form for a DI,
so we add an antecedent inside the existential:
\begin{equation}
\label{eq:rt-di-pr-88}
        \begin{gathered}
        \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
        ( \V{originB} < \V{current} \lor \epsilon \neq \epsilon ) \implies \\
                \left( \begin{gathered}
        \V{S} \destar \Velement{w}{0,\V{originB}} \cat \V{B} \cat \V{unseen} \\
                \derives \Velement{w}{0,\V{originB}} \cat \V{rhs} \mydot \V{unseen} \\
        \destar \Velement{w}{0,\V{current}} \mydot \V{unseen}
                \end{gathered}  \right).
        }
        \end{gathered}
\end{equation}
From the rule for B \eqref{eq:rt-di-pr-12},
we know that
\begin{equation}
\label{eq:rt-di-pr-90}
\V{rhs} \in (\V{N}\cup\V{T})^\ast.
\end{equation}
Together,
\eqref{eq:rt-di-pr-12},
\eqref{eq:rt-di-pr-88} and
\eqref{eq:rt-di-pr-90} are equivalent to the DI
\begin{equation}
\label{eq:rt-di-pr-94}
\FA{DI}{\V{rhs},\epsilon,\V{B},\V{originB},\V{current}}.
\end{equation}
From \Dfref{tangible-inflows}, we see that
\eqref{eq:rt-di-pr-94} is the tributary of \eqref{eq:df-rt-di}.
Therefore, with
\eqref{eq:rt-di-pr-94}, we have what we needed to show for the lemma.
        \myqed
\end{proof}

\begin{lemma}[Tangible reduction mainstem]
        \label{lm:rt-main}
        Every tangible reduction DI \Dfref{rt}
        has a mainstem \Dfref{tangible-inflows}.
        \lmEnd
\end{lemma}

\begin{proof}
        We assumed for the lemma that we have a tangible reduction DI.
        Without loss of generality, let this be
\begin{equation}
        \label{eq:pr-rm-di}
        \V{down} = \FA{DI}{\V{antepredotA}\cat\V{B},\V{postdotA},\V{A},\V{origin},\V{current}}, \\
\end{equation}
where
\begin{gather}
        \label{eq:pr-rt-main-10}
\V{antepredotA} \in(\V{N}\cup\V{T})^\ast, \\
        \label{eq:pr-rt-main-12}
\text{the predot symbol is $\V{B} \in \V{N}$,} \\
        \label{eq:pr-rt-main-14}
\text{the predot symbol instance derives $\Velement{w}{\V{originB},\V{current}}$, and} \\
        \label{eq:pr-rt-main-16}
\V{originB} < \V{current}.
\end{gather}
        \todo{Define predot symbol instance}

        We can expand the DI \V{down} in \ref{eq:pr-rm-di} to
\begin{gather}
        \label{eq:pr-rt-main-20}
        \V{antepredotA}\cat\V{B} \in (\V{N} \cup \V{T})^\ast \\
        \land \; \V{postdotA} \in (\V{N} \cup \V{T})^\ast \\
        \label{eq:pr-rt-main-22}
        \land \; (\V{A} \de \V{antepredotA} \cat \V{B} \cat \V{postdotA}) \in \V{P} \text{, and} \\
        \label{eq:pr-rt-main-24}
        \left( \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdotA} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen}
                \end{gathered} \right)
                }
        \end{gathered} \right).
\end{gather}

As one of the sentential forms in \eqref{eq:pr-rt-main-24}, we have
\begin{equation}
        \label{eq:pr-rt-main-30}
        \Velement{w}{0,\V{origin}} \cat \V{antepredotA}\cat\V{B} \mydot \V{postdotA} \cat \V{unseen}
\end{equation}
so that
\begin{gather}
\label{eq:pr-rt-main-32}
        \V{origin} \le \V{originB} \cuz \eqref{eq:pr-rt-main-14}, \eqref{eq:pr-rt-main-30} \text{, and} \\
\label{eq:pr-rt-main-34}
        \V{origin} < \V{current} \cuz \eqref{eq:pr-rt-main-16}, \eqref{eq:pr-rt-main-32}.
\end{gather}

We use \eqref{eq:pr-rt-main-34} to simplify \eqref{eq:pr-rt-main-24}:
\begin{equation}
        \label{eq:pr-rt-main-38}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen}.
                }
        \end{gathered}
\end{equation}

From \eqref{eq:pr-rt-main-12}, \eqref{eq:pr-rt-main-14},
and \eqref{eq:pr-rt-main-38}
we see that
\begin{equation}
        \label{eq:pr-rt-main-40}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \;
                \begin{gathered}
                        \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                        \V{postdotA} \cat \V{unseen} \\
                \end{gathered} \\
                \destar \;
                \begin{gathered}
                \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \cat \Velement{w}{\V{originB},\V{current}} \mydot \\
                \V{postdotA} \cat \V{unseen}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}

The dot location is not part of the derviations,
and may be moved earlier on the RHS without
changing the set of derivations in the DI of \eqref{eq:pr-rt-main-38}.
We now move the dot from after the predot symbol instance,
to before it.
\begin{equation}
        \label{eq:pr-rt-main-42}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen} \\
                \destar \;
                \begin{gathered}
                        \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{originB}} \mydot \\
                        \Velement{w}{\V{originB},\V{current}} \cat \V{postdotA} \cat \V{unseen}.
                \end{gathered}
                }
        \end{gathered}
\end{equation}

To begin to put \eqref{eq:pr-rt-main-42} into the form of a DI expansion,
we first pull back the frontier,
so that \V{B} is in the last step of the derivation schema
\todo{define derivation schema}
instead of \Velement{w}{\V{originB},\V{current}}.
\begin{equation}
        \label{eq:pr-rt-main-44}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{originB}} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen}.
                }
        \end{gathered}
\end{equation}

In moving from \eqref{eq:pr-rt-main-42} to
\eqref{eq:pr-rt-main-44} we become indifferent to the terminals which \V{B} produces
in \eqref{eq:pr-rt-main-44}.
As a result, the derivation set \eqref{eq:pr-rt-main-44} is a superset
of the derivation set \eqref{eq:pr-rt-main-42}.
Our chain of deductions remains valid, because it remains the case
that the DI expansion that we are about to deduce is implied by all the
derivations in the derivation set \eqref{eq:pr-rt-main-42}.

We now proceed to shape \eqref{eq:pr-rt-main-44}
back into the form of a DI expansion.
We first add an antecedant:
\begin{equation}
        \label{eq:pr-rt-main-48}
        \begin{gathered}
                ( \V{originB} < \V{current} \lor (\V{B} \cat \V{postdotA}) \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{originB}} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen}
                \end{gathered} \right).
                }
        \end{gathered}
\end{equation}
In addition to \eqref{eq:pr-rt-main-48}, the DI expansion requires some
preliminary assumptions.
To obtain these, we note
\begin{gather}
        \label{eq:pr-rt-main-50}
        \V{antepredotA} \in (\V{N} \cup \V{T})^\ast \cuz \eqref{eq:pr-rt-main-20} \text{, and} \\
        \label{eq:pr-rt-main-52}
        \V{B} \cat \V{postdotA} \in (\V{N} \cup \V{T})^\ast \cuz \eqref{eq:pr-rt-main-20}.
\end{gather}
Equations \eqref{eq:pr-rt-main-22}, \eqref{eq:pr-rt-main-48}, \eqref{eq:pr-rt-main-50} and
\eqref{eq:pr-rt-main-52} are the expansion of the DI
\begin{equation}
\label{eq:pr-rt-main-54}
        \FA{DI}{\V{antepredotA}, \V{B}\cat\V{postdotA},\V{A},\V{origin},\V{originB}}. \\
\end{equation}
From \Dfref{tangible-inflows}, we see that
\eqref{eq:pr-rt-main-54} is the mainstem of \eqref{eq:df-rt-di}.
Therefore, with
\eqref{eq:pr-rt-main-54}, we have what we needed to show for the lemma.
\myqed
\end{proof}

\begin{lemma}[Intangible reduction mainstem]
        \label{lm:ri-main}
        Every intangible reduction FD \Dfref{rt}
        is either a nulling completion,
        or has a mainstem \Dfref{tangible-inflows}
        at the current location of the FD's focus.
        \lmEnd
\end{lemma}

\begin{proof}
Let our intangible reduction FD be, without loss of generality,
\begin{equation}
        \label{eq:pr-ri-main-003}
        \V{fd} = (\V{down}, \V{drv})
\end{equation}
where
\begin{gather}
        \label{eq:pr-ri-main-005}
        \V{down} = \Fname{Focus}
                \left( \begin{gathered}
                        \V{antepredotA}\cat\V{B:f},\; \V{postdotA},\; \V{A:f}, \\
                        \V{origin},\; \V{current}
                \end{gathered} \right ) \\
        \label{eq:pr-ri-main-012}
\text{$\V{B} \in \V{N}$,} \\
        \label{eq:pr-ri-main-014}
\V{B:f} \deplusV{drv} \epsilon, \\
        \label{eq:pr-ri-main-016}
\text{\V{down} is not a nulling completion,} \\
        \label{eq:pr-ri-main-020}
        \V{antepredotA}\cat\V{B} \in (\V{N} \cup \V{T})^\ast, \\
        \land \; \V{postdotA} \in (\V{N} \cup \V{T})^\ast, \\
        \label{eq:pr-ri-main-022}
        \land \; (\V{A} \de \V{antepredotA} \cat \V{B} \cat \V{postdotA}) \in \V{P} \text{, and} \\
        \label{eq:pr-ri-main-024}
        \left( \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{postdotA} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                        \V{S} \destarV{drv} \Velement{w}{0,\V{origin}} \cat \V{A:f} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B:f} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen}
                \end{gathered} \right)
                }
        \end{gathered} \right).
\end{gather}
We know, also by assumption for the lemma, that
        \begin{equation}
                \label{eq:pr-ri-main-030}
                \neg ( \V{A} \destarW{\V{di}} \epsilon \land \V{postdotA} = \epsilon) \,\cuz\, \eqref{eq:pr-ri-main-016}.
        \end{equation}
Using the helper lemma,
\begin{equation}
                \label{eq:pr-ri-main-040}
                \V{origin} < \V{current} \lor \V{postdotA} \neq \epsilon
                        \,\cuz\, \eqref{eq:pr-ri-main-030}, \Lmref{di-ante-help},
\end{equation}
we simplify \eqref{eq:pr-ri-main-024} to
\begin{equation}
        \label{eq:pr-ri-main-050}
        \begin{gathered}
        \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A:f} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B:f} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{postdotA} \cat \V{unseen}
        } \\
        \cuz \eqref{eq:pr-ri-main-024}, \eqref{eq:pr-ri-main-040}.
        \end{gathered}
\end{equation}
\begin{equation}
        \label{eq:pr-ri-main-060}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A:f} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B:f} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \;
                \begin{gathered}
                        \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{current}} \cat \V{B:f} \mydot \\
                \V{postdotA} \cat \V{unseen}
                \end{gathered} \\
                \destar \;
                \begin{gathered}
                \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{current}} \cat \epsilon \mydot \\
                \V{postdotA} \cat \V{unseen}.
                \end{gathered}
                } \\
                \cuz \eqref{eq:pr-ri-main-014}, \eqref{eq:pr-ri-main-050}, \Dfref{di}.
        \end{gathered}
\end{equation}
We now move the dot from after \V{B} to before it.
\begin{equation}
        \label{eq:pr-ri-main-070}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A:f} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \cat \V{B:f} \mydot \V{postdotA} \cat \V{unseen} \\
                \destar \;
                \begin{gathered}
                        \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{current}} \mydot \\
                                \V{B:f} \cat \V{postdotA} \cat \V{unseen}
                \end{gathered} \\
                \destar \;
                \begin{gathered}
                \Velement{w}{0,\V{origin}} \cat \Velement{w}{\V{origin},\V{current}} \mydot \\
                        \V{postdotA} \cat \V{unseen}.
                \end{gathered}
                } \\
                \cuz \eqref{eq:pr-ri-main-060}.
        \end{gathered}
\end{equation}
        \todo{Revised to here}
\begin{equation}
        \label{eq:pr-ri-main-090}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen} \\
                \destar \;
                \begin{gathered}
                        \Velement{w}{0,\V{current}} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen}
                \end{gathered}
                } \\
                \cuz \eqref{eq:pr-ri-main-070}, \eqref{eq:pr-ri-main-080}.
        \end{gathered}
\end{equation}
To obtain the DI for the mainstem,
we convert \eqref{eq:pr-ri-main-080} back into the form for a DI
by adding an antecedant:
\begin{equation}
        \label{eq:pr-ri-main-100}
        \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{origin} < \V{current} \lor \V{B} \cat \V{postdotA} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{origin}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{origin}} \cat \V{antepredotA} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen} \\
                \destar \; \Velement{w}{0,\V{current}} \mydot \V{B} \cat \V{postdotA} \cat \V{unseen}
                }
                \end{gathered} \right) \\
                \cuz \eqref{eq:pr-ri-main-090}.
        \end{gathered}
\end{equation}
The DI will also require two new assumptions:
\begin{gather}
        \label{eq:pr-ri-main-110}
        \V{antepredotA} \cat \V{B} \in (\V{N} \cup \V{T})^\ast \cuz \eqref{eq:pr-ri-main-20} \text{, and} \\
        \label{eq:pr-ri-main-120}
        \V{postdotA} \in (\V{N} \cup \V{T})^\ast \cuz \eqref{eq:pr-ri-main-20}.
\end{gather}
Equations \eqref{eq:pr-ri-main-22}, \eqref{eq:pr-ri-main-100}, \eqref{eq:pr-ri-main-110} and
\eqref{eq:pr-ri-main-120} are the expansion of the DI
\begin{equation}
\label{eq:pr-ri-main-130}
        \FA{DI}{\V{antepredotA}, \V{B}\cat\V{postdotA},\V{A},\V{origin},\V{current}}. \\
\end{equation}
From \Dfref{tangible-inflows}, we see that
\eqref{eq:pr-ri-main-130} is the mainstem of \eqref{eq:pr-ri-main-5}.
Therefore, with
\eqref{eq:pr-ri-main-130}, we have what we needed to show for the lemma.
\myqed
\todo{Check proof of intangible reduction DI mainstem lemma}
\end{proof}

\begin{lemma}[Prediction mainstem]
        \label{lm:prediction-stem}
        Every prediction DI \Dfref{rt}
        is either a nulling completion,
        or has a mainstem \Dfref{tangible-inflows}.
        \lmEnd
\end{lemma}

\begin{proof}
\todo{Check proof from here}
        We assumed for the lemma that we have an prediction DI.
        Without loss of generality, let this be
\begin{equation}
        \label{eq:pr-pred-main-5}
        \V{down} = \FA{DI}{\epsilon,\V{rhsA},\V{A:focus},\V{current},\V{current}}, \\
\end{equation}
where
\begin{gather}
        \label{eq:pr-pred-main-10}
\V{rhsA} \in(\V{N}\cup\V{T})^\ast, \\
        \label{eq:pr-pred-main-16}
\text{\V{down} is not a nulling completion.}
\end{gather}

        We can expand the DI \V{down} in \ref{eq:pr-rm-di} to
\begin{gather}
        \label{eq:pr-pred-main-20}
        \V{rhsA} \in (\V{N} \cup \V{T})^\ast \\
        \land \; (\V{A} \de \V{rhsA}) \in \V{P} \text{, and} \\
        \label{eq:pr-pred-main-24}
        \left( \begin{gathered}
                \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                ( \V{current} < \V{current} \lor \V{rhsA} \neq \epsilon ) \implies \\
                \left( \begin{gathered}
                \V{S} \destar \Velement{w}{0,\V{current}} \cat \V{A} \cat \V{unseen} \\
                        \destar \Velement{w}{0,\V{current}} \mydot \V{rhsA} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{rhsA} \cat \V{unseen}
                \end{gathered} \right)
                }
        \end{gathered} \right).
\end{gather}
We know by assumption for the lemma that
        \begin{equation}
                \label{eq:pr-pred-main-030}
                \neg ( \V{A} \destarW{\V{di}} \epsilon \land \V{rhsA} = \epsilon) \,\cuz\, \eqref{eq:pr-pred-main-16}.
        \end{equation}
Using the helper lemma,
\begin{equation}
                \label{eq:pr-pred-main-040}
                \V{current} < \V{current} \lor \V{rhsA} \neq \epsilon
                        \,\cuz\, \eqref{eq:pr-pred-main-030}, \Lmref{di-ante-help},
\end{equation}
we simplify \eqref{eq:pr-pred-main-24} to
\begin{equation}
        \label{eq:pr-pred-main-050}
        \begin{gathered}
        \existQ{ \V{unseen} \in (\V{N}\cup\V{T})^\ast }{ \\
                \V{S} \destar \Velement{w}{0,\V{current}} \cat \V{A} \cat \V{unseen} \\
                \destar \Velement{w}{0,\V{current}} \mydot \V{rhsA} \cat \V{unseen}
        } \\
        \cuz \eqref{eq:pr-pred-main-24}, \eqref{eq:pr-pred-main-040}.
        \end{gathered}
\end{equation}
\todo{Finish proof}
\myqed
\end{proof}

\section{Completion lemmas}

\begin{lemma}[Row 0 completion]
        Row 0 is complete.
        \lmEnd
\end{lemma}

\begin{proof}
        Proof is omitted because it is straightforward,
        and essentially the same
        as others in the literature.
        \myqed
\end{proof}

\begin{lemma}[Scansion completion]
        Scansion is complete in row $\V{i}+1$ if
        row \V{i} is complete.
        \lmEnd
\end{lemma}

\begin{proof}
        Proof is omitted because it is straightforward,
        and essentially the same
        as others in the literature.
        \myqed
\end{proof}

\begin{lemma}[Row completion step]
        \label{lm:row-step}
        Reductions are complete in generation $\V{g}+1$
        of row $\V{i}+1$ if
        the rows as far as \V{i} are complete,
        and row $\V{i+1}$ is complete as far as generation \V{g}.
        \lmEnd
\end{lemma}

\begin{proof}
        We consider, without loss of generality, a generation
        DI \V{di}, focused in a derivation \V{drv}.
        We need to show for the lemma that, if
                \todo{Refer to definition of completeness?}
        \begin{gather}
                \label{eq:row-step-050}
                \text{\V{di} is not a nulling completion;} \\
                \label{eq:row-step-055}
                \text{\V{di} is in generation $\V{g}+1$ of row \V{i};} \\
                \label{eq:row-step-060}
                \text{rows 0 through \V{i} are complete; and} \\
                \label{eq:row-step-070}
                \text{generations 0 through \V{g} are complete in row $\V{i}+1$;}
        \end{gather}
        then the code in
        Section~\ref{sec:algorithm}
        on page~\ref{sec:algorithm}
        adds the Earley item
        \V{di} to \V{rows}.

        \begin{equation}
        \label{eq:row-step-080}
                \text{\V{di} is not in generation 0 \cuz \eqref{eq:row-step-055}.}
        \end{equation}
        \begin{equation}
        \label{eq:row-step-090}
                \myparbox{\V{di} is a prediction; a reduction with a tangible predot symbol;
                or a a reduction with an intangible predot symbol
                \cuz \eqref{eq:row-step-080}.}
        \end{equation}
        We proceed by cases.
        \par
        \vspace{2ex}\noindent\textbf{Case 1: Prediction.}
        \begin{equation}
        \label{eq:row-step-100}
                \text{\V{di} is a prediction \cuz Assumption for the case.}
        \end{equation}
        \begin{equation}
        \label{eq:row-step-105}
                \begin{gathered}
                        \text{\V{di} has a mainstem DI in \V{drv}, call it \V{stem}} \\
                        \text{\cuz \eqref{eq:row-step-050}, \eqref{eq:row-step-100}, \Lmref{prediction-stem}.}
                \end{gathered}
        \end{equation}
        \begin{equation}
        \label{eq:row-step-110}
                \begin{gathered}
                \text{\V{stem} is in generation \V{g} or earlier} \\
                \text{\cuz \eqref{eq:row-step-055}, \eqref{eq:row-step-105}, \Dfref{generation}.}
                \end{gathered}
        \end{equation}
        \begin{equation}
        \label{eq:row-step-120}
                \begin{gathered}
                        \text{The Earley item corresponding to \V{stem} exists in \V{rows}} \\
                        \text{\cuz \eqref{eq:row-step-070}, \eqref{eq:row-step-110}.}
                \end{gathered}
        \end{equation}
        Looking at the code, we see that
        \begin{equation}
        \label{eq:row-step-130}
                \begin{gathered}
                \text{the Earley item corresponding to \V{di} is created in \V{rows}} \\
                        \text{\cuz \eqref{eq:row-step-100}, \eqref{eq:row-step-120},
                                \Algref{finish-row}, \Algref{predictions}.}
                \end{gathered}
        \end{equation}
        Equation \eqref{eq:row-step-130} shows the case for predictions,
        which started at \eqref{eq:row-step-100}.
        \par
        \vspace{2ex}\noindent\textbf{Case 2: Reduction with intangible predot symbol.}
        \begin{equation}
        \label{eq:row-step-200}
                \myparbox{\V{di} is a reduction with an intangible predot symbol \cuz Assumption for the case.}
        \end{equation}
\todo{Fix this case}
\todo{Figure out what to do about the inflow lemma}
        \begin{equation}
        \label{eq:row-step-205}
                \begin{gathered}
                        \text{\V{di} has a mainstem DI in \V{drv}, call it \V{stem}} \\
                        \text{\cuz \eqref{eq:row-step-050}, \eqref{eq:row-step-200}, Inflow lemma (TODO!).}
                \end{gathered}
        \end{equation}
        \begin{equation}
        \label{eq:row-step-210}
                \begin{gathered}
                \text{\V{stem} is in generation \V{g} or earlier} \\
                \text{\cuz \eqref{eq:row-step-055}, \eqref{eq:row-step-205}, \Dfref{generation}.}
                \end{gathered}
        \end{equation}
        \begin{equation}
        \label{eq:row-step-220}
                \begin{gathered}
                        \text{The Earley item corresponding to \V{stem} exists in \V{rows}} \\
                        \text{\cuz \eqref{eq:row-step-070}, \eqref{eq:row-step-210}.}
                \end{gathered}
        \end{equation}
        Looking at the code, we see that
\todo{Look more carefully at algorithms}
        \begin{equation}
        \label{eq:row-step-230}
                \begin{gathered}
                \text{the Earley item corresponding to \V{di} is created in \V{rows}} \\
                        \text{\cuz \eqref{eq:row-step-200}, \eqref{eq:row-step-220},
                                \Algref{finish-row}, Look more carefully at algorithms (TODO!).}
                \end{gathered}
        \end{equation}
        Equation \eqref{eq:row-step-230} shows the case for reductions
with intangible predcot symbols.
        which started at \eqref{eq:row-step-200}.
        \todo{Finish this case}
        \par
        \vspace{2ex}\noindent\textbf{Case 3: Reduction with tangible predot symbol.}
        \begin{equation}
        \label{eq:row-step-400}
                \myparbox{\V{di} is a reduction with a tangible predot symbol \cuz Assumption for the case.}
        \end{equation}
        \par
        \todo{Finish this case}
        \todo{Finish this proof}
        \myqed
\end{proof}

\begin{lemma}[Row completion]
        Row $\V{i}+1$ is complete
        if the rows as far as row \V{i} are complete.
        \lmEnd
\end{lemma}

\begin{proof}
        We use induction on the generations of row \V{i}.
        \todo{Finish this proof}
        \myqed
\end{proof}

\begin{theorem}[The llguidance Earley algorithm is complete]
        Row $\V{i}+1$ is complete
        if the rows as far as row \V{i} are complete.
        \lmEnd
\end{theorem}

\begin{proof}
        We use induction on the rows.
        \todo{Finish this proof}
        \myqed
\end{proof}

\FloatBarrier

{
\clearpage

% Ragged right, do not hyphenate.
\RaggedRight
\hyphenpenalty=10000
\exhyphenpenalty=10000

% Silence current hbox warnings, but allow them if
% badness increases further
\hbadness=2000

\begin{thebibliography}{10}

\bibitem{AH1972v1}
\newblock{Aho, Alfred V., and Jeffrey D. Ullman.}
\newblock{\em The theory of parsing, translation, and compiling. Vol. 1.}
\newblock{Prentice-Hall, 1972.}

\bibitem{Kegler2023}
\newblock{Jeffrey Kegler.}
\newblock{``Marpa, A practical general parser: the recognizer''.}
\newblock{\url{https://arxiv.org/abs/1910.08129}.
   Retrieved 2 December, 2024.}

\bibitem{llguidance}
\newblock{llguidance team.}
\newblock{"Low-level guidance parser".}
\newblock{
  \url{https://github.com/microsoft/llguidance}.
  Retrieved 2 December, 2024.}

\end{thebibliography}

} % RaggedRight

% \clearpage
% \phantomsection
% \listofalgorithms

\clearpage
\phantomsection
\renewcommand{\listtheoremname}{Formal apparatus}

\clearpage
\phantomsection
\pdfbookmark[0]{\listtheoremname}{listoflemmas}
% swapnumber would be cool, but is not in the thmtools in
% the latest Raspbian
\listoftheorems[ignoreall,onlynamed=observation,
    show={lemma,ldef,theorem,example,remark,definition}]

\ifdraft{
    \clearpage
    \phantomsection
    \listoftodos
}{}

\end{document}
